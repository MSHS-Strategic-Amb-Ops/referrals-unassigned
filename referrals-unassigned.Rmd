---
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
    fig_width: 7
    fig_height: 6
---


<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>
<style>
.tocify {
color: black;
}
<!-- } -->
<!-- .tocify .tocify-header { -->
<!--     position: fixed; -->
<!--     <!-- top: 50px; --> -->
<!--     left: 50px; -->
<!--     width: 350px; -->
<!--     <!-- border: solid 3px black; --> -->
<!--     <!-- height: 200px; --> -->
<!--  border: none; -->
<!-- } -->
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>
<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #212070;
     }
</style>
<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}

# # Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 8000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  # library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
  library(RODBC)
  library(DBI)
  library(odbc)
  library(dbplyr)
  library(pool)
  library(emojifont)
})


```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================

# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )

# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors

MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}

# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 

  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color

# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)

# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order

MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}



# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Use in ggplot 
  # scale_color_MountSinai("main")

```


```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```



```{r Reporting Variables, echo = FALSE, warning = FALSE, message = FALSE}

report_run_date <- Sys.Date()
# report_run_date <- "2022-08-10"
reporting_week <- floor_date(as.Date(report_run_date, "%Y-%m-%d")-7, unit="week", week_start = 7)
reporting_week_prior <- floor_date(as.Date(report_run_date, "%Y-%m-%d")-14, unit="week", week_start = 7)
reporting_week_next <- floor_date(as.Date(report_run_date, "%Y-%m-%d"), unit="week", week_start = 7)

reporting_year <- format(as.Date(report_run_date), "%Y")
reporting_month <- format(as.Date(report_run_date), "%b")
reporting_monthNum <- format(as.Date(report_run_date), "%m")


```


```{r Import Referrals Data, echo = FALSE, warning = FALSE, message = FALSE}

path <- "/nfs/data/Applications/Ambulatory/Data_Updated/"
# saveRDS(referral_vol, paste0(path,"referral_vol.rds"))

referral_vol <- readRDS(paste0(path,"referral_vol.rds"))

# referral_vol <- readRDS("referral_vol (3).rds")

```


<!-- ```{r Referrals Data Importing, echo = FALSE, warning = FALSE, message = FALSE} -->

<!-- # Connect to Database ---------------------------------------------------------- -->
<!-- # conn1 <- odbcConnect("Caboodle") # Connect to Server -->

<!-- conn1 <- dbPool(drv = odbc(), dsn = "Caboodle", timeout = 30) -->

<!-- # Import Referrals+Visit Data -------------------------------------------------- -->
<!-- referrals_conn <- tbl(conn1, "Referrals") -->
<!-- referrals_raw <- referrals_conn %>% -->
<!--   mutate(StartInstant = as.Date(StartInstant)) %>% -->
<!--   filter(StartInstant >= as.Date("2022-04-01") & StartInstant < report_run_date) %>% -->
<!--   filter(Status != "Canceled") %>% -->
<!--   # group_by(SentBySite, SentByDept, SentByDepID, StartInstant) %>% -->
<!--   # summarise(total = n()) %>% -->
<!--   collect() -->


<!-- # Import Referrals Data for Addtional Referral Details ------------------------- -->
<!-- # referralFactAll <- sqlQuery(conn1, "SELECT TOP 10* FROM PRDREPORT.FullAccess.ReferralFact") -->
<!-- referralFact_conn <- tbl(conn1, "ReferralFact") -->

<!-- referralFact_raw <- referralFact_conn %>% -->
<!--   # head(1000) %>% -->
<!--   # collect() -->
<!--   mutate(StartInstant = as.Date(StartInstant)) %>% -->
<!--   filter(StartInstant >= as.Date("2022-04-01") & StartInstant <= report_run_date) %>% -->
<!--   group_by(ReferralKey, ReferredToDepartmentSpecialty, StartInstant, `_CreationInstant`, `_LastUpdatedInstant`, LastEnteredWorkqueueDateKey_X, -->
<!--            LastEnteredWorkqueueTimeKey_X, LastEnteredWorkqueueName_X, -->
<!--            Class, Priority, Redirected, Rejected, TriageRejectionReason, InAnyWorkqueue, StatusReason, SchedulingStatus, -->
<!--            FirstCallMadeInstant, FirstEncounterCreatedInstant, FirstEncounterInstant, ExpirationInstant, -->
<!--            WasPatientContactedWithin12Hours_X, -->
<!--            ProfessionalChargeAmount, ProfessionalChargeEstimate, HospitalChargeEstimate) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   collect() -->

<!-- referralFact_raw$total <- NULL -->

<!-- # referralFact_all <- referralFact_conn %>% -->
<!-- #   mutate(StartInstant = as.Date(StartInstant)) %>% -->
<!-- #   filter(StartInstant == as.Date("2022-11-03")) %>% -->
<!-- #   collect() -->

<!-- visitFact_conn <- tbl(conn1, "VisitFact") -->
<!-- visitFact_raw <- visitFact_conn %>% -->
<!--   filter(ReferralKey >0) %>% -->
<!--   group_by(ReferralKey, AppointmentStatus, AppointmentCreationDateKey, AppointmentCancellationDateKey) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   collect() %>% -->
<!--   group_by(ReferralKey) %>% -->
<!--   mutate(first_appt = as.Date(as.character(min(AppointmentCreationDateKey)),  format = "%Y%m%d")) -->

<!-- # Append Additional Referral Columns ------------------------------------------- -->
<!-- referrals_merged <- left_join(referrals_raw, subset(referralFact_raw, select = -c(StartInstant, Priority))) -->
<!-- referrals_merged <- referrals_merged %>% -->
<!--   mutate(SentByDepID = as.character(SentByDepID), -->
<!--          ReceivedByDepID = as.character(ReceivedByDepID)) -->

<!-- ``` -->


<!-- ```{r Referrals Data Processing, echo = FALSE, warning = FALSE, message = FALSE} -->

<!-- # Referrals Raw Data Processing ------------------------------------------------ -->
<!-- # Priority Groups ============================================================= -->
<!-- referrals_merged <- referrals_merged %>% -->
<!--   mutate(createdWeek = floor_date(as.Date(StartInstant, "%Y-%m-%d"), unit="week", week_start = 7), -->
<!--          createdYear = format(as.Date(StartInstant, "%Y-%m-%d"),"%Y"), -->
<!--          createdMonNum = as.numeric(format(as.Date(StartInstant, "%Y-%m-%d"),"%m")), -->
<!--          createdMonth = format(as.Date(StartInstant, "%Y-%m-%d"),"%B"), -->
<!--          createdMonthYear = format(as.Date(StartInstant, "%Y-%m-%d"),"%m-%Y")) %>% -->
<!--   mutate(priority_type = case_when(str_detect(toupper(Priority), "CONVENIENCE") ~ "Patient Convenience" -->
<!--                                    ,str_detect(toupper(Priority), "2 DAYS") ~ "Within 2 Days" -->
<!--                                    ,str_detect(toupper(Priority), "1 WEEK") ~ "Within 1 Week" -->
<!--                                    ,str_detect(toupper(Priority), "2 WEEKS") ~ "Within 2 Weeks" -->
<!--                                    ,str_detect(toupper(Priority), "3-6 Days") ~ "Within 1 Week" # Question: Should this be separate category? -->
<!--                                    ,str_detect(toupper(Priority), "7-14 Days") ~ "Within 2 Weeks" -->
<!--                                    ,Priority == "Routine" ~ "Routine" -->
<!--                                    ,TRUE ~ "Not Specified")) -->

<!-- ``` -->


<!-- ```{r Unique Referral Volume Data, echo = FALSE, warning = FALSE, message = FALSE} -->

<!-- # Unique Referrals by Appointment Status ------------------------------------------------------- -->
<!-- referrals_processed <- referrals_merged %>% -->
<!--   group_by(ReferralKey) %>% -->
<!--   mutate(ApptStatusFinal = NA) %>% -->
<!--   mutate(ApptStatusFinal = case_when((is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("Arrived","Completed"))) ~ "Arrived" -->
<!--                                      ,(is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("No Show", "Left without seen"))) ~ "No Show" -->
<!--                                      ,(is.na(ApptStatusFinal) & any(AppointmentStatus == "Canceled")) ~ "Canceled" -->
<!--                                      ,(is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("Scheduled","Confirmed"))) ~ "Scheduled" -->
<!--                                      ,TRUE ~ "Pending")) -->


<!-- # Unique Referral Volume by Appointment Status ------------------------------------------------- -->
<!-- referral_vol <- referrals_processed %>% -->
<!--   group_by(SentBySite, SentByDepID, SentByDept, SentBySpecialty, -->
<!--            ReceivedBySite, ReceivedByDepID, ReceivedByDept, ReceivedBySpecialty, ReferredToDepartmentSpecialty, -->
<!--            StartInstant, createdYear, createdMonthYear, createdMonNum, createdMonth, createdWeek, ReferralKey, ReferralEpicId, ProcedureName, priority_type, ApptStatusFinal, -->
<!--            Class, WasPatientContactedWithin12Hours_X, CreationToFirstEncounterDate, ExpirationInstant, -->
<!--            ProfessionalChargeEstimate, HospitalChargeEstimate, Redirected, Rejected, TriageRejectionReason, InAnyWorkqueue, -->
<!--            Patient_MRN, ICD_10_Chosen, -->
<!--            Status, CloseReason, SchedulingStatus) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   # mutate(SentBySpecialty = case_when(SentByDept %in% c("MS EPICCARE LINK","MS RYAN CENTER LINK") ~ "ECL" -->
<!--   #                               # ,str_detect(toupper(SentByDept), "EMERGENCY") ~ "ED" -->
<!--   #                               # ,SentByDept == "EMERGENCY DEPARTMENT PSYCH" ~ "ED Psych" -->
<!--   #                               # ,SentByDept == "CPEP PSYCH ED BI" ~ "ED Psych" -->
<!--   #                               , TRUE ~ SentBySpecialty)) %>% -->
<!--   mutate(SentBySite = case_when(SentByDept %in% c("MS RYAN CENTER LINK") ~ "RYAN CENTER" -->
<!--                                      # ,SentByDept == "EMERGENCY DEPT BI" ~ "MSBI" -->
<!--                                      # ,SentByDept == "EMERGENCY DEPT MORNINGSIDE" ~ "MSM" -->
<!--                                      # ,SentByDept == "EMERGENCY DEPT WEST" ~ "MSW" -->
<!--                                      # ,SentByDept == "EMERGENCY DEPARTMENT" ~ "MSH" -->
<!--                                      # ,SentByDept == "EMERGENCY DEPT QUEENS" ~ "MSQ" -->
<!--                                      # ,SentByDept == "EMERGENCY DEPT BI BROOKLYN" ~ "MSB" -->
<!--                                      # ,SentByDept == "EMERGENCY DEPARTMENT PSYCH" ~ "MSH" -->
<!--                                      # ,SentByDept == "CPEP PSYCH ED BI" ~ "MSBI" -->
<!--                                      ,TRUE ~ SentBySite)) -->

<!-- referral_vol$referral_age <- difftime(report_run_date-1, as.Date(referral_vol$StartInstant, "%Y-%m%-%d"), units = "days") -->


<!-- # Merge Appointment Scheduled Date  -->
<!-- referral_vol$first_appt_created <- visitFact_raw$first_appt[match(referral_vol$ReferralKey, visitFact_raw$ReferralKey)] -->
<!-- referral_vol <- referral_vol %>% -->
<!--   mutate(scheduledWeek = floor_date(as.Date(first_appt_created, "%Y-%m-%d"), unit="week", week_start = 7), -->
<!--          scheduledYear = format(as.Date(first_appt_created, "%Y-%m-%d"),"%Y"), -->
<!--          scheduledMonNum = as.numeric(format(as.Date(first_appt_created, "%Y-%m-%d"),"%m")), -->
<!--          scheduledMonth = format(as.Date(first_appt_created, "%Y-%m-%d"),"%B"), -->
<!--          scheduledMonthYear = format(as.Date(first_appt_created, "%Y-%m-%d"),"%m-%Y"), -->
<!--          scheduledYearMonth = format(as.Date(first_appt_created, "%Y-%m-%d"),"%Y-%m"))  -->
<!--   # mutate(leadDays = difftime(StartInstant, first_appt_created, units = "days"))  -->


<!-- # saveRDS(referral_vol, "referral_vol.rds") -->
<!-- # referral_vol <- readRDS("referral_vol.rds") -->
<!-- ``` -->


<!-- ```{r} -->

<!-- test <- referrals_raw %>% -->
<!--   filter(Class == "Internal") %>% -->
<!--   filter(ReceivedByDept == "*Unspecified") -->

<!-- test2 <- left_join(test, future_scheduling_raw[,c("PAT_ENC_CSN_ID","REFERRAL_ID")], by=c('EncounterEpicCsn'='PAT_ENC_CSN_ID')) -->

<!-- require(openxlsx) -->
<!-- write.xlsx(test2, "Referrals wihtout Receiving Department 4.11.2023 V2.xlsx") -->
<!-- ``` -->


```{r Import Future Scheduling Data, echo = FALSE, warning = FALSE, message = FALSE}

# Connection to Oracle DB ------------------------------------------------------
# conn1 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB SoYoun", timeout = 30)
conn2 <- dbConnect(odbc(), 
                  "Clarity_prod", 
                  uid = "kweons01" , 
                  pwd = "kweons01123$")

# Import Slot Availability Data ------------------------------------------------
# slot_raw_tbl <- tbl(conn1, "Y_DM_BOOKED_FILLED_RATE")
access_raw_tbl <- tbl(conn2, "MV_DM_PATIENT_ACCESS")

# date_1 <- paste0(format(Sys.Date(), "%Y-%m-%d"), " 23:59:59")
date_1 <- paste0(format(Sys.Date(), "%Y-%m-%d"), " 00:00:00")
# date_1 <- paste0(format(as.Date("2022-04-01"), "%Y-%m-%d"), " 00:00:00")

future_scheduling_raw <- access_raw_tbl %>%
  filter(TO_DATE(date_1,"YYYY-MM-DD HH24:MI:SS") <= APPT_DTTM) %>%
  group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, MRN, PAT_NAME, PAT_ENC_CSN_ID, REFERRAL_ID, 
           APPT_ENTRY_USER_NAME_WID, APPT_MADE_DTTM, APPT_DTTM, PRC_NAME, DERIVED_STATUS_DESC) %>%
  summarise(total = n()) %>%
  collect() 


future_appts <- future_scheduling_raw %>%
  filter(is.na(REFERRAL_ID)) %>%
  filter(DERIVED_STATUS_DESC == "Scheduled") %>%
  arrange(APPT_DTTM) %>%
  arrange(MRN) %>%
  group_by(MRN, DEPARTMENT_ID) %>%
  mutate(appt_dept = seq_len(n())) %>%
  ungroup() %>%
  group_by(MRN, DEPT_SPECIALTY_NAME)%>%
  mutate(appt_specialty = seq_len(n())) 

```


```{r}

# date_1 <- paste0(as.Date("2023-02-01", "%Y-%m-%d"), " 00:00:00")
# 
# test <- access_raw_tbl %>%
#   filter(APPT_DTTM >= TO_DATE(date_1,"YYYY-MM-DD HH24:MI:SS")) %>%
#   group_by(PAT_ENC_CSN_ID, APPT_DTTM, APPT_MADE_DTTM) %>%
#   summarise(total = n()) %>%
#   collect()
# 
# test$check <- NULL
# test$total <- NULL
# 
# test2 <- access_raw_tbl %>%
#   filter(APPT_MADE_DTTM >= TO_DATE(date_1,"YYYY-MM-DD HH24:MI:SS")) %>%
#   group_by(PAT_ENC_CSN_ID, APPT_DTTM, APPT_MADE_DTTM) %>%
#   summarise(total = n()) %>%
#   collect()
# 
# test3 <- access_raw_tbl %>%
#   filter(APPT_DTTM >= TO_DATE(date_1,"YYYY-MM-DD HH24:MI:SS") | APPT_MADE_DTTM >= TO_DATE(date_1,"YYYY-MM-DD HH24:MI:SS")) %>%
#   group_by(PAT_ENC_CSN_ID, APPT_DTTM, APPT_MADE_DTTM) %>%
#   summarise(total = n()) %>%
#   collect()
# 
# test3$total <- NULL

```


```{r Unassigned Referrals Received, echo = FALSE, warning = FALSE, message = FALSE}

unassigned_referrals <- referral_vol %>%
  filter(ApptStatusFinal == "Pending") %>%
  filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals
  filter(ReceivedByDept != "*Unspecified") %>%
  group_by(ReferralEpicId, ProcedureName, StartInstant, ExpirationInstant, Patient_MRN, ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept, ReceivedByDepID) %>%
  summarise(total = n()) %>%
  dplyr::select(-total) %>%
  mutate(exclude = case_when(str_detect(ProcedureName, "COLONOSCOPY|NUTRITION") ~ "Exclude",
                             TRUE ~ "")) %>%
  filter(exclude != "Exclude")


unassigned_referrals_dept <- merge(unassigned_referrals, 
              future_appts %>% filter(appt_dept == 1) %>% 
                dplyr::select(MRN, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, APPT_DTTM, APPT_ENTRY_USER_NAME_WID), 
              by.x = c("Patient_MRN", "ReceivedByDepID"),
              by.y = c("MRN", "DEPARTMENT_ID"))

unassigned_referrals_dept <- unassigned_referrals_dept %>% # Remove upcoming appts beyond referral expiration
  filter(as.Date(ExpirationInstant) >= as.Date(APPT_DTTM))
unassigned_referrals_dept$ExpirationInstant <- NULL


unassigned_referrals_specialty <- merge(unassigned_referrals, 
              future_appts %>% filter(appt_specialty == 1) %>% 
                dplyr::select(MRN, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, APPT_DTTM, APPT_ENTRY_USER_NAME_WID), 
              by.x = c("Patient_MRN", "ReferredToDepartmentSpecialty"),
              by.y = c("MRN", "DEPT_SPECIALTY_NAME"))
unassigned_referrals_specialty <- unassigned_referrals_specialty %>% # Remove upcoming appts beyond referral expiration
  filter(as.Date(ExpirationInstant) >= as.Date(APPT_DTTM))
unassigned_referrals_specialty$ExpirationInstant <- NULL


unassigned_referrals_merged <- bind_rows(unassigned_referrals_dept, unassigned_referrals_specialty)
unassigned_referrals_merged <- unassigned_referrals_merged %>%
  dplyr::select(-DEPT_SPECIALTY_NAME) %>%
  dplyr::select(-DEPARTMENT_ID) %>%
  distinct()

unassigned_referrals_future_appts <- left_join(unassigned_referrals, unassigned_referrals_merged)
unassigned_referrals_future_appts <- unassigned_referrals_future_appts %>%
  mutate(type = case_when(!is.na(DEPARTMENT_NAME) & ReceivedByDept == DEPARTMENT_NAME ~ "Earliest scheduled in same department",
                          !is.na(DEPARTMENT_NAME) ~ "Earliest scheduled in same specialty",
                          TRUE ~ ""))

```


```{r Unassigned Referrals Sent, echo = FALSE, warning = FALSE, message = FALSE}

unassigned_referrals_sent <- referral_vol %>%
  filter(ApptStatusFinal == "Pending") %>%
  filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals
  group_by(ReferralEpicId, ProcedureName, StartInstant, ExpirationInstant, Patient_MRN, SentBySite, SentBySpecialty, SentByDept, SentByDepID, ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept, ReceivedByDepID) %>%
  summarise(total = n()) %>%
  dplyr::select(-total) %>%
  mutate(exclude = case_when(str_detect(ProcedureName, "COLONOSCOPY|NUTRITION") ~ "Exclude",
                             TRUE ~ "")) %>%
  filter(exclude != "Exclude")


unassigned_referrals_dept_sent <- merge(unassigned_referrals_sent, 
              future_appts %>% filter(appt_dept == 1) %>% 
                dplyr::select(MRN, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, APPT_DTTM, APPT_ENTRY_USER_NAME_WID), 
              by.x = c("Patient_MRN", "ReceivedByDepID"),
              by.y = c("MRN", "DEPARTMENT_ID"))

unassigned_referrals_dept_sent <- unassigned_referrals_dept_sent %>% # Remove upcoming appts beyond referral expiration
  filter(as.Date(ExpirationInstant) >= as.Date(APPT_DTTM))
unassigned_referrals_dept_sent$ExpirationInstant <- NULL


unassigned_referrals_specialty_sent <- merge(unassigned_referrals_sent, 
              future_appts %>% filter(appt_specialty == 1) %>% 
                dplyr::select(MRN, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, APPT_DTTM, APPT_ENTRY_USER_NAME_WID), 
              by.x = c("Patient_MRN", "ReferredToDepartmentSpecialty"),
              by.y = c("MRN", "DEPT_SPECIALTY_NAME"))
unassigned_referrals_specialty_sent <- unassigned_referrals_specialty_sent %>% # Remove upcoming appts beyond referral expiration
  filter(as.Date(ExpirationInstant) >= as.Date(APPT_DTTM))
unassigned_referrals_specialty_sent$ExpirationInstant <- NULL


unassigned_referrals_merged_sent <- bind_rows(unassigned_referrals_dept_sent, unassigned_referrals_specialty_sent)
unassigned_referrals_merged_sent <- unassigned_referrals_merged_sent %>%
  dplyr::select(-DEPT_SPECIALTY_NAME) %>%
  dplyr::select(-DEPARTMENT_ID) %>%
  distinct()

unassigned_referrals_future_appts_sent <- left_join(unassigned_referrals_sent, unassigned_referrals_merged_sent)
unassigned_referrals_future_appts_sent <- unassigned_referrals_future_appts_sent %>%
  mutate(type = case_when(!is.na(DEPARTMENT_NAME) & ReceivedByDept == DEPARTMENT_NAME ~ "Earliest scheduled in same department",
                          !is.na(DEPARTMENT_NAME) ~ "Earliest scheduled in same specialty",
                          TRUE ~ ""))

```


```{r Sinai Logo, echo=FALSE, out.width = '30%'}
knitr::include_graphics("Mount_Sinai_Logo_H.png")
```


# Ambulatory Unassigned Referrals Report
*Report Run Date: `r report_run_date`*<br/>
*Data Date Range: From 2022-04-01 to `r report_run_date - 1`*<br/>
*Data Source: EPIC Caboodle Referrals Data and Clarity Scheduling Data*<br/>
*Active unassigned referrals with potential upcoming visits excludes expired referrals and referrals with potential upcoming appointments scheduled for after referral expiration date*
*Excludes Nutrition and Colonoscopy referrals*<br/>

:::: {.blackbox data-latex=""}
::: {.center data-latex=""}
<span style='font-size: 18px;; color: #d80b8c'>**Metric Definitions:**</span>
<br/>
<span style='font-size: 16px;'>-- **Conversion Rate:** Total referrals with **scheduled visits** over total referrals received</span><br/>
<span style='font-size: 16px;'>-- **Completion Rate:** Total referrals with **arrived visits** over total referrals received</span><br/>
<span style='font-size: 16px;'>-- **Expired Unassigned Rate:** Total referrals expired with **no visits linked** over total referrals received</span><br/>
<span style='font-size: 16px;'>-- **Unassigned Referrals:** Total referrals with **no visits linked** over total referrals received</span>
<br/>
:::
::::

## Referrals Summary {.tabset .tabset-fade .tabset-pills}
### Referrals Received
```{r Referrals Received Output, echo = FALSE, warning = FALSE, message = FALSE}

referrals_summary_site <- referral_vol %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  adorn_totals("row", "Total") %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>%
  mutate(Total = sum(across(where(is.numeric)))) %>%
  mutate(conversion_rate = round((Total - Pending)/Total ,2),
         completion_rate = round(Arrived/Total, 2),
         unassigned_perc = round(Pending/ Total,2))

expired_summary_site <- referral_vol %>%
  filter(ExpirationInstant < report_run_date) %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  adorn_totals("row", "Total") %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>%
  mutate(Total = sum(across(where(is.numeric)))) %>%
  dplyr::select(ReceivedBySite, ReferredToDepartmentSpecialty, Pending) %>%
  rename(expired_unassigned = Pending)

referrals_summary_site <- left_join(referrals_summary_site, expired_summary_site)
referrals_summary_site <- referrals_summary_site %>%
  mutate(expired_unassigned_perc = round(expired_unassigned/Total,2))

unassigned_referrals_future_appts_summary <- unassigned_referrals_merged %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ReferralEpicId) %>%
  summarise(total = n()) %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>%
  summarise(future_appts = n())

referrals_summary_site <- merge(referrals_summary_site, unassigned_referrals_future_appts_summary)
  
referrals_summary_site <- referrals_summary_site %>%
  mutate(unassigned_appts_perc = round(future_appts/Pending,2)) 

referrals_summary_site[is.na(referrals_summary_site)] <- 0

reactable(
  referrals_summary_site %>%
    dplyr::select(ReceivedBySite, ReferredToDepartmentSpecialty, Total, Arrived, Pending, 
                  conversion_rate, completion_rate, expired_unassigned, expired_unassigned_perc, future_appts),
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  
  groupBy = c("ReceivedBySite", "ReferredToDepartmentSpecialty"),
  
  
  columns = list(
    
    ReceivedBySite = colDef(
      # footer = "Total",
      name = "Site",
      minWidth = 180),
    
    ReferredToDepartmentSpecialty = colDef(
      # footer = "Total",
      name = "Specialty",
      minWidth = 180),
    
    Total = colDef(
      name = "Total Referrals Received",
      minWidth = 100,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", borderRight = "1.5px solid rgb(230, 230, 230)")
    ),
    
    # Arrived = colDef(
    #   name = "Referrals with Completed Appointments",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = "sum",
    #   # footer = JS("function(column, state) {
    #   #   let total = 0
    #   #   state.sortedData.forEach(function(row) {
    #   #     total += row[column.id]
    #   #   })
    #   #   return total.toFixed(0).toLocaleString()
    #   # }"),
    #   format = colFormat(separators = TRUE, digits = 0)
    # ),
    # 
    # Pending = colDef(
    #   name = "Referrals Unassigned (No Visits Linked)",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = "sum",
    #   # footer = JS("function(column, state) {
    #   #   let total = 0
    #   #   state.sortedData.forEach(function(row) {
    #   #     total += row[column.id]
    #   #   })
    #   #   return total.toFixed(0)
    #   # }"),
    #   format = colFormat(separators = TRUE, digits = 0),
    #   style = list(borderRight = "1.5px solid rgb(230, 230, 230)")
    # ),
    
    conversion_rate = colDef(
      name = "Conversion Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalPending = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalPending += row['Pending']
        })
        return (totalTotal - totalPending) / totalTotal
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['conversion_rate']
        if (value > 0.5) {
          var color = '#008000'
        } else if (value <= 0.5 ) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
    
    completion_rate = colDef(
      name = "Completion Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalArrived = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalArrived += row['Arrived']
        })
        return totalArrived / totalTotal
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['completion_rate']
        if (value > 0.5) {
          var color = '#008000'
        } else if (value <= 0.5 ) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
    
    expired_unassigned_perc = colDef(
      name = "Expired Referrals Unassigned Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalExpiredUnassigned = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalExpiredUnassigned += row['expired_unassigned']
        })
        return totalExpiredUnassigned / totalTotal
      }"),
      # style = JS("function(rowInfo) {
      #   var value = rowInfo.row['completion_rate']
      #   if (value > 0.5) {
      #     var color = '#008000'
      #   } else if (value <= 0.5 ) {
      #     var color = '#e00000'
      #   } else {
      #     var color = '#000000'
      #   }
      #   return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      # }"),
      style = list(color = "#e00000", fontWeight = "bold"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
 
    future_appts = colDef(
      name = "Active Unassigned Referrals with Potential Upcoming Appointments",
      minWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff")
    ),
    
    Arrived = colDef(
      show = F
    ),
    
    Pending = colDef(
      show = F
    ),
    
    expired_unassigned = colDef(
      show = F
    )
    
  ) # Close Columns
  
  ) # Close Reactable

```
<br/>
<br/>


### Referrals Sent
```{r Referrals Sent Output, echo = FALSE, warning = FALSE, message = FALSE}

referrals_summary_site_sent <- referral_vol %>%
  group_by(SentBySite, SentBySpecialty, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  adorn_totals("row", "Total") %>%
  group_by(SentBySite, SentBySpecialty) %>%
  mutate(Total = sum(across(where(is.numeric)))) %>%
  mutate(conversion_rate = round((Total - Pending)/Total ,2),
         completion_rate = round(Arrived/Total, 2),
         unassigned_perc = round(Pending/ Total,2))

expired_summary_site_sent <- referral_vol %>%
  filter(ExpirationInstant < report_run_date) %>%
  group_by(SentBySite, SentBySpecialty, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  adorn_totals("row", "Total") %>%
  group_by(SentBySite, SentBySpecialty) %>%
  mutate(Total = sum(across(where(is.numeric)))) %>%
  dplyr::select(SentBySite, SentBySpecialty, Pending) %>%
  rename(expired_unassigned = Pending)

referrals_summary_site_sent <- left_join(referrals_summary_site_sent, expired_summary_site_sent)
referrals_summary_site_sent <- referrals_summary_site_sent %>%
  mutate(expired_unassigned_perc = round(expired_unassigned/Total,2))

unassigned_referrals_future_appts_summary_sent <- unassigned_referrals_merged_sent %>%
  group_by(SentBySite, SentBySpecialty, ReferralEpicId) %>%
  summarise(total = n()) %>%
  group_by(SentBySite, SentBySpecialty) %>%
  summarise(future_appts = n())

referrals_summary_site_sent <- merge(referrals_summary_site_sent, unassigned_referrals_future_appts_summary_sent)
  
referrals_summary_site_sent <- referrals_summary_site_sent %>%
  mutate(unassigned_appts_perc = round(future_appts/Pending,2)) 

referrals_summary_site_sent[is.na(referrals_summary_site_sent)] <- 0

reactable(
  referrals_summary_site_sent %>%
    dplyr::select(SentBySite, SentBySpecialty, Total, Arrived, Pending, 
                  conversion_rate, completion_rate, expired_unassigned, expired_unassigned_perc, future_appts),
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  
  groupBy = c("SentBySite", "SentBySpecialty"),
  
  
  columns = list(
    
    SentBySite = colDef(
      # footer = "Total",
      name = "Sent Site",
      minWidth = 180),
    
    SentBySpecialty = colDef(
      # footer = "Total",
      name = "Sent Specialty",
      minWidth = 180),
    
    Total = colDef(
      name = "Total Referrals Sent",
      minWidth = 100,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", borderRight = "1.5px solid rgb(230, 230, 230)")
    ),
    
    # Arrived = colDef(
    #   name = "Referrals with Completed Appointments",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = "sum",
    #   # footer = JS("function(column, state) {
    #   #   let total = 0
    #   #   state.sortedData.forEach(function(row) {
    #   #     total += row[column.id]
    #   #   })
    #   #   return total.toFixed(0).toLocaleString()
    #   # }"),
    #   format = colFormat(separators = TRUE, digits = 0)
    # ),
    # 
    # Pending = colDef(
    #   name = "Referrals Unassigned (No Visits Linked)",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = "sum",
    #   # footer = JS("function(column, state) {
    #   #   let total = 0
    #   #   state.sortedData.forEach(function(row) {
    #   #     total += row[column.id]
    #   #   })
    #   #   return total.toFixed(0)
    #   # }"),
    #   format = colFormat(separators = TRUE, digits = 0),
    #   style = list(borderRight = "1.5px solid rgb(230, 230, 230)")
    # ),
    
    conversion_rate = colDef(
      name = "Conversion Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalPending = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalPending += row['Pending']
        })
        return (totalTotal - totalPending) / totalTotal
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['conversion_rate']
        if (value > 0.5) {
          var color = '#008000'
        } else if (value <= 0.5 ) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
    
    completion_rate = colDef(
      name = "Completion Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalArrived = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalArrived += row['Arrived']
        })
        return totalArrived / totalTotal
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['completion_rate']
        if (value > 0.5) {
          var color = '#008000'
        } else if (value <= 0.5 ) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
    
    expired_unassigned_perc = colDef(
      name = "Expired Referrals Unassigned Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalExpiredUnassigned = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalExpiredUnassigned += row['expired_unassigned']
        })
        return totalExpiredUnassigned / totalTotal
      }"),
      # style = JS("function(rowInfo) {
      #   var value = rowInfo.row['completion_rate']
      #   if (value > 0.5) {
      #     var color = '#008000'
      #   } else if (value <= 0.5 ) {
      #     var color = '#e00000'
      #   } else {
      #     var color = '#000000'
      #   }
      #   return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      # }"),
      style = list(color = "#e00000", fontWeight = "bold"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
 
    future_appts = colDef(
      name = "Active Unassigned Referrals with Potential Upcoming Appointments",
      minWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff")
    ),
    
    Arrived = colDef(
      show = F
    ),
    
    Pending = colDef(
      show = F
    ),
    
    expired_unassigned = colDef(
      show = F
    )
    
  ) # Close Columns
  
  ) # Close Reactable

```
<br/>
<br/>


## Unassigned Referrals {.tabset .tabset-fade .tabset-pills}
### Referrals Received
```{r Received Unassigned Output, echo = FALSE, warning = FALSE, message = FALSE}

unassigned_output <- unassigned_referrals_future_appts %>%
    filter(type != "") %>%
    dplyr::select(ReferralEpicId, Patient_MRN, StartInstant, ProcedureName, ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept,
                  type, DEPARTMENT_NAME, APPT_DTTM, APPT_ENTRY_USER_NAME_WID) %>%
    arrange(desc(APPT_DTTM)) %>%
    arrange(ReferralEpicId, Patient_MRN) %>%
    rename(ScheduledDept = DEPARTMENT_NAME,
           AppointmentDateTime = APPT_DTTM) %>%
    mutate(AppointmentDateTime = as.character(AppointmentDateTime)) %>%
  pivot_wider(names_from = type, 
              values_from = ScheduledDept:APPT_ENTRY_USER_NAME_WID) %>%
  rename(Future_Dept_ApptDate = `AppointmentDateTime_Earliest scheduled in same department`,
         Future_Dept_Scheduler = `APPT_ENTRY_USER_NAME_WID_Earliest scheduled in same department`,
         Future_Specialty_Dept = `ScheduledDept_Earliest scheduled in same specialty`,
         Future_Specialty_ApptDate = `AppointmentDateTime_Earliest scheduled in same specialty`,
         Future_Specialty_Scheduler = `APPT_ENTRY_USER_NAME_WID_Earliest scheduled in same specialty`
         ) %>%
  ungroup() %>%
  dplyr::select(StartInstant, ReferralEpicId, Patient_MRN, ProcedureName, ReceivedBySite, ReferredToDepartmentSpecialty, 
                ReceivedByDept, Future_Dept_ApptDate, Future_Dept_Scheduler,
                Future_Specialty_Dept, Future_Specialty_ApptDate, Future_Specialty_Scheduler)


htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Data (Unassigned Referrals with Potential Upcoming Appointments)"),
      onclick = "Reactable.downloadDataCSV('unassigned-download-table', 'Unassigned Referrals Data')"
    ),

    reactable(
      unassigned_output %>%
        arrange(ReceivedBySite, ReferredToDepartmentSpecialty),
      style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    searchable = TRUE,
    
    groupBy = c("ReceivedBySite", "ReferredToDepartmentSpecialty", "ReceivedByDept"),
    elementId = "unassigned-download-table",
    
    columns = list(
    
    ReceivedBySite = colDef(
      # footer = "Total",
      # name = "Site",
      minWidth = 180),
    
    ReferredToDepartmentSpecialty = colDef(
      # footer = "Total",
      # name = "Specialty",
      minWidth = 180),
    
    ReceivedByDept = colDef(
      # footer = "Total",
      # name = "Department",
      minWidth = 180),
    
    Patient_MRN = colDef(
      # footer = "Total",
      name = "Patient MRN"),
    
    StartInstant = colDef(
      # footer = "Total",
      name = "Referral Created Date"),
    
    ProcedureName = colDef(
      # footer = "Total",
      name = "Procedure Name"),
    
    Future_Dept_ApptDate = colDef(
      # footer = "Total",
      name = "ReceivedByDept Appt Date"),
    
    Future_Dept_Scheduler = colDef(
      # footer = "Total",
      name = "ReceivedByDept Scheduled By"),
    
    Future_Specialty_Dept = colDef(
      # footer = "Total",
      name = "ReceivedBySpecialty Department"),
    
    Future_Specialty_ApptDate = colDef(
      # footer = "Total",
      name = "ReceivedBySpecialty Appt Date"),
    
    Future_Specialty_Scheduler = colDef(
      # footer = "Total",
      name = "ReceivedBySpecialty Scheduled By")
    
    )
    
#     columns = list(
#   AppointmentDateTime = colDef(format = colFormat(datetime = TRUE))
#   # date = colDef(format = colFormat(date = TRUE)),
#   # time = colDef(format = colFormat(time = TRUE)),
#   # time_24h = colDef(format = colFormat(time = TRUE, hour12 = FALSE)),
#   # datetime_pt_BR = colDef(format = colFormat(datetime = TRUE, locales = "pt-BR"))
# )

    )
  )
)


# datatable(
#   unassigned_referrals_future_appts %>%
#     filter(type != "") %>%
#     dplyr::select(ReferralEpicId, Patient_MRN, StartInstant, ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept,
#                   type, DEPARTMENT_NAME, APPT_DTTM) %>%
#     arrange(desc(APPT_DTTM)) %>%
#     arrange(ReferralEpicId, Patient_MRN) %>%
#     rename(ScheduledDept = DEPARTMENT_NAME,
#            AppointmentDateTime = APPT_DTTM) %>%
#     mutate(AppointmentDateTime = as.character(AppointmentDateTime))
#     ,
#   extensions = 'Buttons', options = list(
#     dom = 'Bfrtip',
#     buttons = 
#       list('copy', 'print', list(
#         extend = 'collection',
#         buttons = c('csv', 'excel', 'pdf'),
#         text = 'Download'
#       )),
#     initComplete = JS(
#     "function(settings, json) {",
#     "$('body').css({'font-family': 'Calibri'});",
#     "}"
#   )
#     
#   )
# ) %>%
#   formatDate(10, "toLocaleString")

```


### Referrals Sent
```{r Sent Unassigned Output, echo = FALSE, warning = FALSE, message = FALSE}

unassigned_output_sent <- unassigned_referrals_future_appts_sent %>%
    filter(type != "") %>%
    dplyr::select(SentBySite, SentBySpecialty, SentByDept, ReferralEpicId, Patient_MRN, StartInstant, ProcedureName, ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept,
                  type, DEPARTMENT_NAME, APPT_DTTM, APPT_ENTRY_USER_NAME_WID) %>%
    arrange(desc(APPT_DTTM)) %>%
    arrange(ReferralEpicId, Patient_MRN) %>%
    rename(ScheduledDept = DEPARTMENT_NAME,
           AppointmentDateTime = APPT_DTTM) %>%
    mutate(AppointmentDateTime = as.character(AppointmentDateTime)) %>%
  pivot_wider(names_from = type, 
              values_from = ScheduledDept:APPT_ENTRY_USER_NAME_WID) %>%
  rename(Future_Dept_ApptDate = `AppointmentDateTime_Earliest scheduled in same department`,
         Future_Dept_Scheduler = `APPT_ENTRY_USER_NAME_WID_Earliest scheduled in same department`,
         Future_Specialty_Dept = `ScheduledDept_Earliest scheduled in same specialty`,
         Future_Specialty_ApptDate = `AppointmentDateTime_Earliest scheduled in same specialty`,
         Future_Specialty_Scheduler = `APPT_ENTRY_USER_NAME_WID_Earliest scheduled in same specialty`) %>%
  ungroup() %>%
  dplyr::select(SentBySite, SentBySpecialty, SentByDept, StartInstant, ReferralEpicId, Patient_MRN, ProcedureName, ReceivedBySite, ReferredToDepartmentSpecialty, 
                ReceivedByDept, Future_Dept_ApptDate, Future_Dept_Scheduler,
                Future_Specialty_Dept, Future_Specialty_ApptDate, Future_Specialty_Scheduler)



htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Data (Unassigned Referrals with Potential Upcoming Appointments)"),
      onclick = "Reactable.downloadDataCSV('sent-unassigned-download-table', 'Unassigned Referrals Data')"
    ),

    reactable(
      unassigned_output_sent %>%
        arrange(SentBySite, SentBySpecialty, SentByDept, ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept),
      style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    searchable = TRUE,
    
    groupBy = c("SentBySite", "SentBySpecialty", "SentByDept"),
    elementId = "sent-unassigned-download-table",
    
    columns = list(
    
    SentBySite = colDef(
      # footer = "Total",
      # name = "Site",
      minWidth = 180),
    
    SentBySpecialty = colDef(
      # footer = "Total",
      # name = "Specialty",
      minWidth = 180),
    
    SentByDept = colDef(
      # footer = "Total",
      # name = "Department",
      minWidth = 180),
    
    ReceivedBySite = colDef(
      # footer = "Total",
      # name = "Site",
      minWidth = 180),
    
    ReferredToDepartmentSpecialty = colDef(
      # footer = "Total",
      # name = "Specialty",
      minWidth = 180),
    
    ReceivedByDept = colDef(
      # footer = "Total",
      # name = "Department",
      minWidth = 180),
    
    Patient_MRN = colDef(
      # footer = "Total",
      name = "Patient MRN"),
    
    StartInstant = colDef(
      # footer = "Total",
      name = "Referral Created Date"),
    
    ProcedureName = colDef(
      # footer = "Total",
      name = "Procedure Name"),
    
    Future_Dept_ApptDate = colDef(
      # footer = "Total",
      name = "ReceivedByDept Appt Date"),
    
    Future_Dept_Scheduler = colDef(
      # footer = "Total",
      name = "ReceivedByDept Scheduled By"),
    
    Future_Specialty_Dept = colDef(
      # footer = "Total",
      name = "ReceivedBySpecialty Department"),
    
    Future_Specialty_ApptDate = colDef(
      # footer = "Total",
      name = "ReceivedBySpecialty Appt Date"),
    
    Future_Specialty_Scheduler = colDef(
      # footer = "Total",
      name = "ReceivedBySpecialty Scheduled By")
    
    )
    
#     columns = list(
#   AppointmentDateTime = colDef(format = colFormat(datetime = TRUE))
#   # date = colDef(format = colFormat(date = TRUE)),
#   # time = colDef(format = colFormat(time = TRUE)),
#   # time_24h = colDef(format = colFormat(time = TRUE, hour12 = FALSE)),
#   # datetime_pt_BR = colDef(format = colFormat(datetime = TRUE, locales = "pt-BR"))
# )

    )
  )
)


# datatable(
#   unassigned_referrals_future_appts %>%
#     filter(type != "") %>%
#     dplyr::select(ReferralEpicId, Patient_MRN, StartInstant, ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept,
#                   type, DEPARTMENT_NAME, APPT_DTTM) %>%
#     arrange(desc(APPT_DTTM)) %>%
#     arrange(ReferralEpicId, Patient_MRN) %>%
#     rename(ScheduledDept = DEPARTMENT_NAME,
#            AppointmentDateTime = APPT_DTTM) %>%
#     mutate(AppointmentDateTime = as.character(AppointmentDateTime))
#     ,
#   extensions = 'Buttons', options = list(
#     dom = 'Bfrtip',
#     buttons = 
#       list('copy', 'print', list(
#         extend = 'collection',
#         buttons = c('csv', 'excel', 'pdf'),
#         text = 'Download'
#       )),
#     initComplete = JS(
#     "function(settings, json) {",
#     "$('body').css({'font-family': 'Calibri'});",
#     "}"
#   )
#     
#   )
# ) %>%
#   formatDate(10, "toLocaleString")

```


