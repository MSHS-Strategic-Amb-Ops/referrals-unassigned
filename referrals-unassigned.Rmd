---
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
    fig_width: 7
    fig_height: 6
---


<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>
<style>
.tocify {
color: black;
}
<!-- } -->
<!-- .tocify .tocify-header { -->
<!--     position: fixed; -->
<!--     <!-- top: 50px; --> -->
<!--     left: 50px; -->
<!--     width: 350px; -->
<!--     <!-- border: solid 3px black; --> -->
<!--     <!-- height: 200px; --> -->
<!--  border: none; -->
<!-- } -->
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>
<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #212070;
     }
</style>
<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}

# # Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 8000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  # library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
  library(RODBC)
  library(DBI)
  library(odbc)
  library(dbplyr)
  library(pool)
  library(emojifont)
})


```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================

# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )

# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors

MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}

# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 

  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color

# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)

# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order

MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}



# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Use in ggplot 
  # scale_color_MountSinai("main")

```


```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```



```{r Reporting Variables, echo = FALSE, warning = FALSE, message = FALSE}

report_run_date <- Sys.Date()
# report_run_date <- "2022-08-10"
reporting_week <- floor_date(as.Date(report_run_date, "%Y-%m-%d")-7, unit="week", week_start = 7)
reporting_week_prior <- floor_date(as.Date(report_run_date, "%Y-%m-%d")-14, unit="week", week_start = 7)
reporting_week_next <- floor_date(as.Date(report_run_date, "%Y-%m-%d"), unit="week", week_start = 7)

reporting_year <- format(as.Date(report_run_date), "%Y")
reporting_month <- format(as.Date(report_run_date), "%b")
reporting_monthNum <- format(as.Date(report_run_date), "%m")


```


```{r Import Referrals Data, echo = FALSE, warning = FALSE, message = FALSE}

# path <- "/nfs/data/Applications/Ambulatory/Data_Updated/"
# saveRDS(referral_vol, paste0(path,"referral_vol.rds"))

# referral_vol <- readRDS(paste0(path,"referral_vol.rds"))


# referral_vol <- readRDS("referral_vol (3).rds")

```


```{r Establish Oracle Connection, echo = FALSE, warning = FALSE, message = FALSE}

report_run_date <- Sys.Date()

# Connect to Database ----------------------------------------------------------
# conn1 <- odbcConnect("Caboodle") # Connect to Server

# conn1 <- dbPool(drv = odbc(), dsn = "Caboodle", timeout = 30)
conn1 <- dbConnect(odbc(),
                    Driver = "SQLServer",
                    # Server = "10.2.42.69", # old server
                    Server = "datahub-synapse.sql.azuresynapse.net",
                    database = "datahub_epic_dw",
                    UID = "MSS_USER",
                    PWD = "Apple_Bees456$",
                    Port = 1433)

conn2 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB SoYoun", timeout = 30)
conn3 <- dbConnect(odbc(), 
                  "Clarity_prod", 
                  uid = "kweons01" , 
                  pwd = "kweons01123$")


# Caboodle
# referrals_conn <- tbl(conn1, "ReferralsDataView")
referrals_conn <- tbl(conn1, dbplyr::ident_q('"Caboodle"."ReferralsDataView"'))

# referralFact_conn <- tbl(conn1, "ReferralFact")
referralFact_conn <- tbl(conn1, dbplyr::ident_q('"Caboodle"."ReferralFact"'))

# visitFact_conn <- tbl(conn1, "VisitFact")
referralFact_conn <- tbl(conn1, dbplyr::ident_q('"Caboodle"."VisitFact"'))


# Clarity
referrals_tbl <- tbl(conn3, "REFERRAL")
referrals_wq_item_tbl <- tbl(conn3, "REFERRAL_WQ_ITEMS")
referrals_wq_tbl <- tbl(conn3, "REFERRAL_WQ")

```


```{r}


# referrals_raw <- referrals_conn %>%
#   mutate(StartInstant = as.Date(StartInstant)) %>%
#   filter(StartInstant >= as.Date("2024-01-01") & StartInstant < report_run_date) %>%
#   filter(Status != "Canceled") %>%
#   # group_by(Status, CloseReason, AppointmentStatus) %>%
#   # summarise(total = n()) %>%
#   collect()
# 
# 
# referrals_reasons <- referrals_merged %>%
#   filter(ProcedureName %!in% referrals_excl) %>%
#   filter(ReceivedByDept != "*Unspecified") %>%
#   # filter(Status != "Denied") %>%
#   group_by(ReferralEpicId, StartInstant, SentBySite, SentBySpecialty, ReceivedBySite, ReferredToDepartmentSpecialty,  ExpirationInstant,Status, StatusReason, CloseReason, SchedulingStatus) %>%
#   summarise(total = n())
# 
# 
# qpr_referrals_tbl <- tbl(conn2, "PROD_QPR_REFERRAL")
# qpr_referrals <- qpr_referrals_tbl %>%
#   dplyr::select(REFERRAL_ID, SCHEDULED_REFERRAL, ARRIVED_REFERRAL) %>%
#   collect()
# 
# referrals_reasons$SCHEDULED_REFERRAL <- qpr_referrals$SCHEDULED_REFERRAL[match(referrals_reasons$ReferralEpicId, qpr_referrals$REFERRAL_ID)]
# referrals_reasons$ARRIVED_REFERRAL <- qpr_referrals$ARRIVED_REFERRAL[match(referrals_reasons$ReferralEpicId, qpr_referrals$REFERRAL_ID)]
# referrals_reasons$total <- NULL
# 
# referrals_reasons_summary <- referrals_reasons %>%
#   filter(StartInstant < as.Date("2024-07-01")) %>%
#   mutate(SCHEDULED_REFERRAL = ifelse(is.na(SCHEDULED_REFERRAL), NA, "Scheduled"),
#          ARRIVED_REFERRAL = ifelse(is.na(ARRIVED_REFERRAL), NA, "Arrived")) %>%
#   group_by(SentBySite, SentBySpecialty, ReceivedBySite, ReferredToDepartmentSpecialty, StartInstant, ExpirationInstant, 
#            SCHEDULED_REFERRAL, ARRIVED_REFERRAL, Status, StatusReason, CloseReason, SchedulingStatus) %>%
#   summarise(total = n())
# 
# 
# 
# require(openxlsx)
# write.xlsx(referrals_reasons_summary, "Referral Status_Jul23_Jul24.xlsx")
# 
# 
# referral_check <- left_join(referrals_merged, 
#                             qpr_referrals_tbl,
#                             by = c("ReferralKey" = "REFERRAL_ID"),
#                             copy = TRUE)
# 
# 
# 
# 
# 
# 
# referrals_clarity <- referrals_tbl %>%
#    mutate(year = year(ENTRY_DATE),
#          month = month(ENTRY_DATE)) %>%
#   filter(year == 2024) %>%
#   filter(month == 1) %>%
#   collect()
# 
# 
# referrals_clarity_summary <- referrals_clarity %>%
#   filter(RFL_TYPE_C == "78") %>%
#   group_by(year, month) %>%
#   summarise(total = length(unique(REFERRAL_ID)))
# 
# 
# 
# referrals_caboodle <- referrals_conn %>%
#   mutate(year = year(StartInstant),
#          month = month(StartInstant)) %>%
#   filter(year == 2024) %>%
#   filter(month == 1) %>%
#   collect()
#  
# referrals_caboodle_summary <- referrals_caboodle %>%
#   group_by(year, month) %>%
#   summarise(total = length(unique(ReferralEpicId)))
# 
# cols <- as.data.frame(colnames(referrals))
# 
# referrals <- referrals_tbl %>%
#   mutate(year = year(ENTRY_DATE),
#          month = month(ENTRY_DATE)) %>%
#   filter(year >= 2023) %>%
#   group_by(year, month, REFERRAL_ID) %>%
#   summarise(total = n()) %>%
#   collect()
# 
# referrals_vol <- referrals_tbl %>%
#   mutate(year = year(ENTRY_DATE),
#          month = month(ENTRY_DATE)) %>%
#   filter(year >= 2023) %>%
#   group_by(year, month) %>%
#   summarise(total = n()) %>%
```


```{r Referrals Data Importing, echo = FALSE, warning = FALSE, message = FALSE}

# Import Referrals+Visit Data --------------------------------------------------
# referrals_conn <- tbl(conn1, "ReferralsDataView")
referrals_raw <- referrals_conn %>%
  mutate(StartInstant = as.Date(StartInstant)) %>%
  filter(StartInstant >= as.Date("2023-07-01") & StartInstant < report_run_date) %>%
  filter(Status != "Canceled") %>%
  collect()


# dep <- referrals_conn %>%
#   group_by(ReceivedBySite, ReceivedByDept) %>%
#   summarise(total = n()) %>%
#   collect()

# Import Referrals Data for Addtional Referral Details -------------------------
# referralFactAll <- sqlQuery(conn1, "SELECT TOP 10* FROM PRDREPORT.FullAccess.ReferralFact")
# referralFact_conn <- tbl(conn1, "ReferralFact")

referralFact_raw <- referralFact_conn %>%
  # head(10) %>%
  # collect()
  mutate(StartInstant = as.Date(StartInstant)) %>%
  filter(StartInstant >= as.Date("2023-07-01") & StartInstant <= report_run_date) %>%
  group_by(ReferralKey, ReferredToDepartmentSpecialty, StartInstant, `_CreationInstant`, `_LastUpdatedInstant`, LastEnteredWorkqueueDateKey_X,
           LastEnteredWorkqueueTimeKey_X, LastEnteredWorkqueueName_X,
           Class, Priority, Redirected, Rejected, TriageRejectionReason, InAnyWorkqueue, StatusReason, SchedulingStatus,
           FirstCallMadeInstant, FirstEncounterCreatedInstant, FirstEncounterInstant, ExpirationInstant,
           WasPatientContactedWithin12Hours_X,
           ProfessionalChargeAmount, ProfessionalChargeEstimate, HospitalChargeEstimate,
           PrimaryCoverageKey, PendingReason) %>%
  summarise(total = n()) %>%
  # left_join(coverage_payor_plan_tbl, 
  #           by = "COVERAGE_ID",
  #           copy = TRUE) %>%
  collect()

referralFact_raw$total <- NULL

# referralFact_all <- referralFact_conn %>%
#   mutate(StartInstant = as.Date(StartInstant)) %>%
#   filter(StartInstant == as.Date("2022-11-03")) %>%
#   collect()

# visitFact_conn <- tbl(conn1, "VisitFact")
visitFact_raw <- visitFact_conn %>%
  filter(ReferralKey >0) %>%
  group_by(ReferralKey, AppointmentStatus, AppointmentCreationDateKey, AppointmentCancellationDateKey) %>%
  summarise(total = n()) %>%
  collect() %>%
  group_by(ReferralKey) %>%
  mutate(first_appt = as.Date(as.character(min(AppointmentCreationDateKey)),  format = "%Y%m%d"))


# Append Additional Referral Columns -------------------------------------------
referrals_merged <- left_join(referrals_raw, subset(referralFact_raw, select = -c(StartInstant, Priority)))
referrals_merged <- referrals_merged %>%
  mutate(SentByDepID = as.character(SentByDepID),
         ReceivedByDepID = as.character(ReceivedByDepID))
```

```{r Referrals Data Processing, echo = FALSE, warning = FALSE, message = FALSE}

# Referrals Raw Data Processing ------------------------------------------------
# Priority Groups =============================================================
referrals_merged <- referrals_merged %>%
  mutate(createdWeek = floor_date(as.Date(StartInstant, "%Y-%m-%d"), unit="week", week_start = 7),
         createdYear = format(as.Date(StartInstant, "%Y-%m-%d"),"%Y"),
         createdMonNum = as.numeric(format(as.Date(StartInstant, "%Y-%m-%d"),"%m")),
         createdMonth = format(as.Date(StartInstant, "%Y-%m-%d"),"%B"),
         createdMonthYear = format(as.Date(StartInstant, "%Y-%m-%d"),"%m-%Y")) %>%
  mutate(priority_type = case_when(str_detect(toupper(Priority), "CONVENIENCE") ~ "Patient Convenience"
                                   ,str_detect(toupper(Priority), "2 DAYS") ~ "Within 2 Days"
                                   ,str_detect(toupper(Priority), "1 WEEK") ~ "Within 1 Week"
                                   ,str_detect(toupper(Priority), "2 WEEKS") ~ "Within 2 Weeks"
                                   ,str_detect(toupper(Priority), "3-6 Days") ~ "Within 1 Week" # Question: Should this be separate category?
                                   ,str_detect(toupper(Priority), "7-14 Days") ~ "Within 2 Weeks"
                                   ,Priority == "Routine" ~ "Routine"
                                   ,TRUE ~ "Not Specified"))

```

```{r Unique Referral Volume Data, echo = FALSE, warning = FALSE, message = FALSE}

# Unique Referrals by Appointment Status -------------------------------------------------------
referrals_processed <- referrals_merged %>%
  group_by(ReferralKey) %>%
  mutate(ApptStatusFinal = NA) %>%
  mutate(ApptStatusFinal = case_when((is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("Arrived","Completed"))) ~ "Arrived"
                                     ,(is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("No Show", "Left without seen"))) ~ "No Show"
                                     ,(is.na(ApptStatusFinal) & any(AppointmentStatus == "Canceled")) ~ "Canceled"
                                     ,(is.na(ApptStatusFinal) & any(AppointmentStatus %in% c("Scheduled","Confirmed"))) ~ "Scheduled"
                                     ,TRUE ~ "Pending"))


# Unique Referral Volume by Appointment Status (Department) -------------------------------------------------
referral_vol <- referrals_processed %>%
  group_by(SentBySite, SentByDepID, SentByDept, SentBySpecialty, SentByProvider, SentByProvNPI,
           ReceivedBySite, ReceivedByDepID, ReceivedByDept, ReceivedBySpecialty, ReferredToDepartmentSpecialty, ReceivedByProvider, ReceivedByProvNPI,
           StartInstant, createdYear, createdMonthYear, createdMonNum, createdMonth, createdWeek, ReferralKey, ReferralEpicId, ProcedureName, priority_type, ApptStatusFinal,
           Class, WasPatientContactedWithin12Hours_X, CreationToFirstEncounterDate, ExpirationInstant,
           ProfessionalChargeEstimate, HospitalChargeEstimate, Redirected, Rejected, TriageRejectionReason, InAnyWorkqueue,
           Patient_MRN, ICD_10_Chosen,
           Status, CloseReason, SchedulingStatus) %>%
  summarise(total = n()) %>%
  # mutate(SentBySpecialty = case_when(SentByDept %in% c("MS EPICCARE LINK","MS RYAN CENTER LINK") ~ "ECL"
  #                               # ,str_detect(toupper(SentByDept), "EMERGENCY") ~ "ED"
  #                               # ,SentByDept == "EMERGENCY DEPARTMENT PSYCH" ~ "ED Psych"
  #                               # ,SentByDept == "CPEP PSYCH ED BI" ~ "ED Psych"
  #                               , TRUE ~ SentBySpecialty)) %>%
  mutate(SentBySite = case_when(SentByDept %in% c("MS RYAN CENTER LINK") ~ "RYAN CENTER"
                                     # ,SentByDept == "EMERGENCY DEPT BI" ~ "MSBI"
                                     # ,SentByDept == "EMERGENCY DEPT MORNINGSIDE" ~ "MSM"
                                     # ,SentByDept == "EMERGENCY DEPT WEST" ~ "MSW"
                                     # ,SentByDept == "EMERGENCY DEPARTMENT" ~ "MSH"
                                     # ,SentByDept == "EMERGENCY DEPT QUEENS" ~ "MSQ"
                                     # ,SentByDept == "EMERGENCY DEPT BI BROOKLYN" ~ "MSB"
                                     # ,SentByDept == "EMERGENCY DEPARTMENT PSYCH" ~ "MSH"
                                     # ,SentByDept == "CPEP PSYCH ED BI" ~ "MSBI"
                                     ,TRUE ~ SentBySite))

referral_vol$referral_age <- difftime(report_run_date-1, as.Date(referral_vol$StartInstant, "%Y-%m%-%d"), units = "days")


# Merge Appointment Scheduled Date 
referral_vol$first_appt_created <- visitFact_raw$first_appt[match(referral_vol$ReferralKey, visitFact_raw$ReferralKey)]
referral_vol <- referral_vol %>%
  mutate(scheduledWeek = floor_date(as.Date(first_appt_created, "%Y-%m-%d"), unit="week", week_start = 7),
         scheduledYear = format(as.Date(first_appt_created, "%Y-%m-%d"),"%Y"),
         scheduledMonNum = as.numeric(format(as.Date(first_appt_created, "%Y-%m-%d"),"%m")),
         scheduledMonth = format(as.Date(first_appt_created, "%Y-%m-%d"),"%B"),
         scheduledMonthYear = format(as.Date(first_appt_created, "%Y-%m-%d"),"%m-%Y"),
         scheduledYearMonth = format(as.Date(first_appt_created, "%Y-%m-%d"),"%Y-%m")) 
  # mutate(leadDays = difftime(StartInstant, first_appt_created, units = "days")) 


# saveRDS(referral_vol, "referral_vol.rds")
# referral_vol <- readRDS("referral_vol.rds")
```


```{r Import Future Scheduling Data, echo = FALSE, warning = FALSE, message = FALSE}

# Connection to Oracle DB ------------------------------------------------------
# conn1 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB SoYoun", timeout = 30)
conn2 <- dbConnect(odbc(), 
                  "Clarity_prod", 
                  uid = "kweons01" , 
                  pwd = "kweons01123$")

# Import Slot Availability Data ------------------------------------------------
# slot_raw_tbl <- tbl(conn1, "Y_DM_BOOKED_FILLED_RATE")
access_raw_tbl <- tbl(conn2, "MV_DM_PATIENT_ACCESS")

# date_1 <- paste0(format(Sys.Date(), "%Y-%m-%d"), " 23:59:59")
date_1 <- paste0(format(Sys.Date(), "%Y-%m-%d"), " 00:00:00")
# date_1 <- paste0(format(as.Date("2022-04-01"), "%Y-%m-%d"), " 00:00:00")

future_scheduling_raw <- access_raw_tbl %>%
  filter(TO_DATE(date_1,"YYYY-MM-DD HH24:MI:SS") <= APPT_DTTM) %>%
  group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_NAME_WID, MRN, PAT_NAME, PAT_ENC_CSN_ID, REFERRAL_ID, 
           APPT_ENTRY_USER_NAME_WID, APPT_MADE_DTTM, APPT_DTTM, PRC_NAME, DERIVED_STATUS_DESC) %>%
  summarise(total = n()) %>%
  collect() 

future_scheduling_raw$PROV_NAME_WID <- trimws(gsub("\\[.*?\\]", "", future_scheduling_raw$PROV_NAME_WID))

# Referrals with FUTURE appointments within the same department/specialty
future_appts <- future_scheduling_raw %>%
  filter(is.na(REFERRAL_ID)) %>%
  filter(DERIVED_STATUS_DESC == "Scheduled") %>%
  arrange(APPT_DTTM) %>%
  arrange(MRN) %>%
  group_by(MRN, DEPARTMENT_ID) %>%
  mutate(appt_dept = seq_len(n())) %>%
  ungroup() %>%
  group_by(MRN, DEPT_SPECIALTY_NAME)%>%
  mutate(appt_specialty = seq_len(n())) 

```


```{r Import Past Scheduling Data, echo = FALSE, warning = FALSE, message = FALSE}


# date_1 <- paste0(format(Sys.Date(), "%Y-%m-%d"), " 23:59:59")
date_1 <- paste0(format(Sys.Date(), "%Y-%m-%d"), " 00:00:00")
date_2 <- paste0(format(as.Date("2022-04-01"), "%Y-%m-%d"), " 00:00:00")
# date_2 <- paste0(format(Sys.Date() %m-% months(6), "%Y-%m-%d"), " 00:00:00")

past_scheduling_raw <- access_raw_tbl %>%
  filter(is.na(REFERRAL_ID)) %>%
  filter(DERIVED_STATUS_DESC == "Arrived") %>%
  filter(TO_DATE(date_1,"YYYY-MM-DD HH24:MI:SS") > APPT_DTTM) %>%
  filter(TO_DATE(date_2,"YYYY-MM-DD HH24:MI:SS") <= APPT_DTTM) %>%
  group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_NAME_WID, MRN, PAT_NAME, PAT_ENC_CSN_ID, REFERRAL_ID, 
           APPT_ENTRY_USER_NAME_WID, APPT_MADE_DTTM, APPT_DTTM, PRC_NAME, DERIVED_STATUS_DESC) %>%
  summarise(total = n()) %>%
  collect() 

past_scheduling_raw$PROV_NAME_WID <- trimws(gsub("\\[.*?\\]", "", past_scheduling_raw$PROV_NAME_WID))

# Referrals with FUTURE appointments within the same department/specialty
past_appts <- past_scheduling_raw %>%
  arrange(MRN, DEPARTMENT_ID, desc(APPT_MADE_DTTM), APPT_DTTM) %>%
  group_by(MRN, DEPARTMENT_ID) %>%
  mutate(appt_dept = seq_len(n())) %>%
  ungroup() %>%
  arrange(MRN, DEPT_SPECIALTY_NAME, desc(APPT_MADE_DTTM), APPT_DTTM) %>%
  group_by(MRN, DEPT_SPECIALTY_NAME)%>%
  mutate(appt_specialty = seq_len(n())) 

```


```{r Unassigned Referrals Received, echo = FALSE, warning = FALSE, message = FALSE}

# Exclude referrals that do not result in appts -------------------------------
referrals_excl <- c(
  "AMB REF TO ADOL HEALTH HIV PRE TEST",
  "AMB REF TO AHC LEGAL HEALTH CLINIC",
  "AMB REF TO CARE MANAGEMENT",
  "AMB REF TO COLONOSCOPY (SCREENING)",
  "AMB REF TO COLONOSCOPY,DIAGNOSTIC",
  "AMB REF TO CONDITION MANAGEMENT PROGRAM - REMOTE PATIENT MONITORING",
  "AMB REF TO DUBIN PSYCHOLOGY",
  "AMB REF TO EXTERNAL DENTAL",
  "AMB REF TO EXTERNAL EARLY INTERVENTION",
  "AMB REF TO EXTERNAL OCCUPATIONAL THERAPY",
  "AMB REF TO EXTERNAL PHYSICAL THERAPY",
  "AMB REF TO EXTERNAL SPEECH THERAPY",
  "AMB REF TO FPA SOCIAL WORK",
  "AMB REF TO GMA SOCIAL WORK",
  "AMB REF TO IMA BEHAVIORAL HEALTH (DEPRESSION CARE + IMA PSYCH + IMA EVAL)",
  "AMB REF TO MASSAGE THERAPY",
  "AMB REF TO MFMA CONSULTATIVE SERVICES",
  "AMB REF TO MFMA EVALUATION UNIT",
  "AMB REF TO NUTRITION",
  "AMB REF TO NUTRITION (FPA ASTHMA PROGRAM)",
  "AMB REF TO NUTRITION CVI CLINIC",
  "AMB REF TO PATHOLOGY",
  "AMB REF TO PEDIATRIC SOCIAL WORK/MENTAL HEALTH",
  "AMB REF TO PEDS PSYCHIATRY",
  "AMB REF TO PEDS PSYCHOLOGY",
  "AMB REF TO PSYCHIATRY",
  "AMB REF TO PSYCHIATRY (FPA ASTHMA PROGRAM)",
  "AMB REF TO PSYCHOLOGY",
  "AMB REF TO REGISTERED DIETICIAN",
  "AMB REF TO SOCIAL WORK",
  "AMB REF TO SPECIALTY SOCIAL WORK",
  "AMB REF TO SPIRITUAL CARE",
  "AMB REF TO SW MENTAL HEALTH",
  "AMB REF TO VISITING NURSE SERVICE",
  "AMB REF TO WOMEN, INFANT & CHILDREN'S FOOD SUPPLEMENT PROGRAM",
  "AMBULATORY REFERRAL TO ED"
)



unassigned_referrals <- referral_vol %>%
  filter(ProcedureName %!in% referrals_excl) %>%
  filter(ApptStatusFinal == "Pending") %>%
  filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals
  filter(ReceivedByDept != "*Unspecified") %>%
  filter(Class != "Outgoing") %>%
  filter(Status != "Denied") %>%
  filter(str_detect(ProcedureName, "COLONOSCOPY|NUTRITION") == FALSE) %>%
  group_by(ReferralEpicId, ProcedureName, StartInstant, ExpirationInstant, Patient_MRN, 
           ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept, ReceivedByDepID, ReceivedByProvider, Class, Status) %>%
  summarise(total = n()) %>%
  dplyr::select(-total) %>%
  mutate(ExpirationInstant = as.character(ExpirationInstant))


# Unassigned Referrals with Potential Future Appts within Same DEP ------------
unassigned_referrals_dept <- merge(unassigned_referrals, 
              future_appts %>% filter(appt_dept == 1) %>% 
                dplyr::select(MRN, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, APPT_DTTM, PROV_NAME_WID, PRC_NAME, APPT_ENTRY_USER_NAME_WID), 
              by.x = c("Patient_MRN", "ReceivedByDepID"),
              by.y = c("MRN", "DEPARTMENT_ID")) %>%
  mutate(lead_days = as.Date(APPT_DTTM) - as.Date(StartInstant)) %>%
  filter(lead_days <= 180) %>%
  dplyr::select(-lead_days)

# unassigned_referrals_dept <- unassigned_referrals_dept %>% # Remove upcoming appts beyond referral expiration
#   filter(as.Date(ExpirationInstant) >= as.Date(APPT_DTTM))
# unassigned_referrals_dept$ExpirationInstant <- NULL



# Unassigned Referrals with Potential Future Appts within Same SPECIALTY -------
unassigned_referrals_specialty <- merge(unassigned_referrals, 
              future_appts %>% filter(appt_specialty == 1) %>% 
                dplyr::select(MRN, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, APPT_DTTM, PROV_NAME_WID, PRC_NAME, APPT_ENTRY_USER_NAME_WID), 
              by.x = c("Patient_MRN", "ReferredToDepartmentSpecialty"),
              by.y = c("MRN", "DEPT_SPECIALTY_NAME")) %>%
  mutate(lead_days = as.Date(APPT_DTTM) - as.Date(StartInstant)) %>%
  filter(lead_days <= 180) %>%
  dplyr::select(-lead_days)
# unassigned_referrals_specialty <- unassigned_referrals_specialty %>% # Remove upcoming appts beyond referral expiration
#   filter(as.Date(ExpirationInstant) >= as.Date(APPT_DTTM))
# unassigned_referrals_specialty$ExpirationInstant <- NULL


# Unassigned Referrals with Future Appts within DEP & SPECIALTY Merged ---------
unassigned_referrals_merged <- bind_rows(unassigned_referrals_dept, unassigned_referrals_specialty)
unassigned_referrals_merged <- unassigned_referrals_merged %>%
  dplyr::select(-DEPT_SPECIALTY_NAME) %>%
  dplyr::select(-DEPARTMENT_ID) %>%
  distinct()

unassigned_referrals_future_appts <- left_join(unassigned_referrals, unassigned_referrals_merged)

unassigned_referrals_future_appts <- unassigned_referrals_future_appts %>%
  rename(future_dept = DEPARTMENT_NAME,
         future_appt_dttm = APPT_DTTM,
         future_appt_provider = PROV_NAME_WID,
         future_appt_name = PRC_NAME,
         future_appt_entry = APPT_ENTRY_USER_NAME_WID)
  


# Unassigned Referrals with Potential Past Appts within Same DEP ------------
unassigned_referrals_dept_past <- merge(unassigned_referrals, 
              past_appts %>% filter(appt_dept == 1) %>% 
                dplyr::select(MRN, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, APPT_DTTM, PROV_NAME_WID, PRC_NAME, APPT_ENTRY_USER_NAME_WID), 
              by.x = c("Patient_MRN", "ReceivedByDepID"),
              by.y = c("MRN", "DEPARTMENT_ID")) %>%
  mutate(lead_days = as.Date(APPT_DTTM) - as.Date(StartInstant)) %>%
  filter(lead_days <= 180) %>%
  filter(lead_days >= 0) %>%
  dplyr::select(-lead_days)


# Unassigned Referrals with Potential Past Appts within Same SPECIALTY -------
unassigned_referrals_specialty_past <- merge(unassigned_referrals, 
              past_appts %>% filter(appt_specialty == 1) %>% 
                dplyr::select(MRN, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, APPT_DTTM, PROV_NAME_WID, PRC_NAME, APPT_ENTRY_USER_NAME_WID), 
              by.x = c("Patient_MRN", "ReferredToDepartmentSpecialty"),
              by.y = c("MRN", "DEPT_SPECIALTY_NAME")) %>%
  mutate(lead_days = as.Date(APPT_DTTM) - as.Date(StartInstant)) %>%
  filter(lead_days <= 180) %>%
  filter(lead_days >= 0) %>%
  dplyr::select(-lead_days)


# Unassigned Referrals with Past Appts within DEP & SPECIALTY Merged ---------
unassigned_referrals_merged_past <- bind_rows(unassigned_referrals_dept_past, unassigned_referrals_specialty_past)
unassigned_referrals_merged_past <- unassigned_referrals_merged_past %>%
  dplyr::select(-DEPT_SPECIALTY_NAME) %>%
  dplyr::select(-DEPARTMENT_ID) %>%
  distinct()


unassigned_referrals_appts_merged <- left_join(unassigned_referrals_future_appts, unassigned_referrals_merged_past)

unassigned_referrals_appts_merged <- unassigned_referrals_appts_merged %>%
  rename(past_dept = DEPARTMENT_NAME,
         past_appt_dttm = APPT_DTTM,
         past_appt_provider = PROV_NAME_WID,
         past_appt_name = PRC_NAME,
         past_appt_entry = APPT_ENTRY_USER_NAME_WID)


unassigned_referrals_appts_merged <- unassigned_referrals_appts_merged %>%
  mutate(type = case_when(!is.na(future_dept) & ReceivedByDept == future_dept ~ "Upcoming appt in same department",
                          !is.na(future_dept) ~ "Upcoming appt in same specialty",
                          !is.na(past_dept) & ReceivedByDept == past_dept ~ "Past appt in same department",
                          !is.na(past_dept) & ReceivedByDept == past_dept ~ "Past appt in same specialty",
                          TRUE ~ ""))

```


```{r Unassigned Referrals Sent, echo = FALSE, warning = FALSE, message = FALSE}

unassigned_referrals_sent <- left_join(unassigned_referrals_appts_merged, referral_vol[,c("ReferralEpicId", "SentBySite", "SentBySpecialty", "SentByDept")])

```


```{r Sinai Logo, echo=FALSE, out.width = '30%'}
knitr::include_graphics("Mount_Sinai_Logo_H.png")
```


# Ambulatory Unassigned Referrals Report
*Report Run Date: `r report_run_date`*<br/>
*Data Date Range: From 2022-04-01 to `r report_run_date - 1`*<br/>
*Data Source: EPIC Caboodle Referrals Data and Clarity Scheduling Data*<br/>
*Active unassigned referrals with potential upcoming visits excludes expired referrals and referrals with potential upcoming appointments scheduled for after referral expiration date*<br/>
*Excludes Nutrition and Colonoscopy referrals*<br/>
*Excludes referrals that do not result in appointments (e.g. social work, spiritual care, education, etc)*<br/>
*Excludes "Outgoing" and "Denied" referrals*<br/>

:::: {.blackbox data-latex=""}
::: {.center data-latex=""}
<span style='font-size: 18px;; color: #d80b8c'>**Metric Definitions:**</span>
<br/>
<span style='font-size: 16px;'>-- **Conversion Rate:** Total referrals with **scheduled visits** over total referrals received</span><br/>
<span style='font-size: 16px;'>-- **Completion Rate:** Total referrals with **arrived visits** over total referrals received</span><br/>
<span style='font-size: 16px;'>-- **Expired Unassigned Rate:** Total referrals expired with **no visits linked** over total referrals received</span><br/>
<span style='font-size: 16px;'>-- **Unassigned Referrals:** Total referrals with **no visits linked** over total referrals received</span>
<br/>
:::
::::


```{r Referrals Received Processing, echo = FALSE, warning = FALSE, message = FALSE}

referrals_summary_site <- referral_vol %>%
  filter(ReceivedByDept != "*Unspecified") %>%
  filter(Class != "Outgoing") %>%
  filter(Status != "Denied") %>%
  filter(ProcedureName %!in% referrals_excl) %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  adorn_totals("row", "Total") %>% # Row for MSHS Total  
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>%
  mutate(Total = sum(across(where(is.numeric)))) %>%
  mutate(conversion_rate = round((Total - Pending)/Total ,2),
         completion_rate = round(Arrived/Total, 2),
         unassigned_perc = round(Pending/ Total,2))

expired_summary_site <- referral_vol %>%
  filter(ReceivedByDept != "*Unspecified") %>%
  filter(Class != "Outgoing") %>%
  filter(Status != "Denied") %>%
  filter(ProcedureName %!in% referrals_excl) %>%
  filter(ExpirationInstant < report_run_date) %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  adorn_totals("row", "Total") %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>%
  mutate(Total = sum(across(where(is.numeric)))) %>%
  dplyr::select(ReceivedBySite, ReferredToDepartmentSpecialty, Pending) %>%
  rename(expired_unassigned = Pending)

referrals_summary_site <- left_join(referrals_summary_site, expired_summary_site)
referrals_summary_site <- referrals_summary_site %>%
  mutate(expired_unassigned_perc = round(expired_unassigned/Total,2))

unassigned_referrals_future_appts_summary <- unassigned_referrals_appts_merged %>%
  filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals
  filter(!is.na(future_dept)) %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ReferralEpicId) %>%
  summarise(total = n()) %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>%
  summarise(future_appts = n()) %>%
  adorn_totals("row", "Total") 

referrals_summary_site <- merge(referrals_summary_site, unassigned_referrals_future_appts_summary)

unassigned_referrals_past_appts_summary <- unassigned_referrals_appts_merged %>%
  filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals
  filter(is.na(future_dept)) %>%
  filter(!is.na(past_dept)) %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ReferralEpicId) %>%
  summarise(total = n()) %>%
  group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>%
  summarise(past_appts = n()) %>%
  adorn_totals("row", "Total") 

referrals_summary_site <- merge(referrals_summary_site, unassigned_referrals_past_appts_summary)  

# referrals_summary_site <- referrals_summary_site %>%
#   mutate(unassigned_appts_perc = round(future_appts/Pending,2)) 

referrals_summary_site[is.na(referrals_summary_site)] <- 0

```


```{r Referrals Sent Processing, echo = FALSE, warning = FALSE, message = FALSE}


referrals_summary_site_sent <- referral_vol %>%
  filter(ReceivedByDept != "*Unspecified") %>%
  filter(Class != "Outgoing") %>%
  filter(Status != "Denied") %>%
  filter(ProcedureName %!in% referrals_excl) %>%
  group_by(SentBySite, SentBySpecialty, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  adorn_totals("row", "Total") %>%
  group_by(SentBySite, SentBySpecialty) %>%
  mutate(Total = sum(across(where(is.numeric)))) %>%
  mutate(conversion_rate = round((Total - Pending)/Total ,2),
         completion_rate = round(Arrived/Total, 2),
         unassigned_perc = round(Pending/ Total,2))

expired_summary_site_sent <- referral_vol %>%
  filter(ReceivedByDept != "*Unspecified") %>%
  filter(Class != "Outgoing") %>%
  filter(Status != "Denied") %>%
  filter(ProcedureName %!in% referrals_excl) %>%
  filter(ExpirationInstant < report_run_date) %>%
  group_by(SentBySite, SentBySpecialty, ApptStatusFinal) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = ApptStatusFinal,
              values_from = total,
              values_fill = 0) %>%
  adorn_totals("row", "Total") %>%
  group_by(SentBySite, SentBySpecialty) %>%
  mutate(Total = sum(across(where(is.numeric)))) %>%
  dplyr::select(SentBySite, SentBySpecialty, Pending) %>%
  rename(expired_unassigned = Pending)

referrals_summary_site_sent <- left_join(referrals_summary_site_sent, expired_summary_site_sent)
referrals_summary_site_sent <- referrals_summary_site_sent %>%
  mutate(expired_unassigned_perc = round(expired_unassigned/Total,2))

unassigned_referrals_future_appts_summary_sent <- unassigned_referrals_sent %>%
  filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals
  filter(!is.na(future_dept)) %>%
  group_by(SentBySite, SentBySpecialty, ReferralEpicId) %>%
  summarise(total = n()) %>%
  group_by(SentBySite, SentBySpecialty) %>%
  summarise(future_appts = n()) %>%
  adorn_totals("row", "Total") 

referrals_summary_site_sent <- merge(referrals_summary_site_sent, unassigned_referrals_future_appts_summary_sent)

unassigned_referrals_past_appts_summary_sent <- unassigned_referrals_sent %>%
  filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals
  filter(is.na(future_dept)) %>%
  filter(!is.na(past_dept)) %>%
  group_by(SentBySite, SentBySpecialty, ReferralEpicId) %>%
  summarise(total = n()) %>%
  group_by(SentBySite, SentBySpecialty) %>%
  summarise(past_appts = n()) %>%
  adorn_totals("row", "Total") 

referrals_summary_site_sent <- merge(referrals_summary_site_sent, unassigned_referrals_past_appts_summary_sent)  

# referrals_summary_site <- referrals_summary_site %>%
#   mutate(unassigned_appts_perc = round(future_appts/Pending,2)) 

referrals_summary_site_sent[is.na(referrals_summary_site_sent)] <- 0

```


## Referrals Summary - Site{.tabset .tabset-fade .tabset-pills}
### Referrals Received
```{r Referrals Received Output, echo = FALSE, warning = FALSE, message = FALSE}

reactable(
  referrals_summary_site %>%
    dplyr::select(ReceivedBySite, ReferredToDepartmentSpecialty, Total, Arrived, Pending, 
                  conversion_rate, completion_rate, expired_unassigned, expired_unassigned_perc, future_appts, past_appts),
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  
  rowStyle = function(index) {
            if (index %in% c(length(unique(referrals_summary_site$ReceivedBySite)))) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
  
  groupBy = c("ReceivedBySite", "ReferredToDepartmentSpecialty"),
  
  
  columns = list(
    
    ReceivedBySite = colDef(
      # footer = "Total",
      name = "Site",
      minWidth = 180),
    
    ReferredToDepartmentSpecialty = colDef(
      # footer = "Total",
      name = "Specialty",
      minWidth = 180),
    
    Total = colDef(
      name = "Total Referrals Received",
      minWidth = 100,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", borderRight = "1.5px solid rgb(230, 230, 230)")
    ),
    
    # Arrived = colDef(
    #   name = "Referrals with Completed Appointments",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = "sum",
    #   # footer = JS("function(column, state) {
    #   #   let total = 0
    #   #   state.sortedData.forEach(function(row) {
    #   #     total += row[column.id]
    #   #   })
    #   #   return total.toFixed(0).toLocaleString()
    #   # }"),
    #   format = colFormat(separators = TRUE, digits = 0)
    # ),
    # 
    # Pending = colDef(
    #   name = "Referrals Unassigned (No Visits Linked)",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = "sum",
    #   # footer = JS("function(column, state) {
    #   #   let total = 0
    #   #   state.sortedData.forEach(function(row) {
    #   #     total += row[column.id]
    #   #   })
    #   #   return total.toFixed(0)
    #   # }"),
    #   format = colFormat(separators = TRUE, digits = 0),
    #   style = list(borderRight = "1.5px solid rgb(230, 230, 230)")
    # ),
    
    conversion_rate = colDef(
      name = "Conversion Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalPending = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalPending += row['Pending']
        })
        return (totalTotal - totalPending) / totalTotal
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['conversion_rate']
        if (value > 0.5) {
          var color = '#008000'
        } else if (value <= 0.5 ) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
    
    completion_rate = colDef(
      name = "Completion Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalArrived = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalArrived += row['Arrived']
        })
        return totalArrived / totalTotal
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['completion_rate']
        if (value > 0.5) {
          var color = '#008000'
        } else if (value <= 0.5 ) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
    
    expired_unassigned_perc = colDef(
      name = "Expired Referrals Unassigned Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalExpiredUnassigned = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalExpiredUnassigned += row['expired_unassigned']
        })
        return totalExpiredUnassigned / totalTotal
      }"),
      # style = JS("function(rowInfo) {
      #   var value = rowInfo.row['completion_rate']
      #   if (value > 0.5) {
      #     var color = '#008000'
      #   } else if (value <= 0.5 ) {
      #     var color = '#e00000'
      #   } else {
      #     var color = '#000000'
      #   }
      #   return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      # }"),
      style = list(color = "#e00000", fontWeight = "bold"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
 
    future_appts = colDef(
      name = "Active Unassigned Referrals with Potential UPCOMING Appointments",
      minWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff")
    ),
    
    past_appts = colDef(
      name = "Active Unassigned Referrals with Potential COMPLETED Appointments",
      minWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff")
    ),
    
    Arrived = colDef(
      show = F
    ),
    
    Pending = colDef(
      show = F
    ),
    
    expired_unassigned = colDef(
      show = F
    )
    
  ) # Close Columns
  
  ) # Close Reactable

```
<br/>
<br/>


### Referrals Sent
```{r Referrals Sent Output, echo = FALSE, warning = FALSE, message = FALSE}

reactable(
  referrals_summary_site_sent %>%
    dplyr::select(SentBySite, SentBySpecialty, Total, Arrived, Pending, 
                  conversion_rate, completion_rate, expired_unassigned, expired_unassigned_perc, future_appts, past_appts),
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  
  rowStyle = function(index) {
            if (index %in% c(length(unique(referrals_summary_site_sent$SentBySite)))) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
  
  groupBy = c("SentBySite", "SentBySpecialty"),
  
  
  columns = list(
    
    SentBySite = colDef(
      # footer = "Total",
      name = "Sent Site",
      minWidth = 180),
    
    SentBySpecialty = colDef(
      # footer = "Total",
      name = "Sent Specialty",
      minWidth = 180),
    
    Total = colDef(
      name = "Total Referrals Sent",
      minWidth = 100,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", borderRight = "1.5px solid rgb(230, 230, 230)")
    ),
    
    # Arrived = colDef(
    #   name = "Referrals with Completed Appointments",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = "sum",
    #   # footer = JS("function(column, state) {
    #   #   let total = 0
    #   #   state.sortedData.forEach(function(row) {
    #   #     total += row[column.id]
    #   #   })
    #   #   return total.toFixed(0).toLocaleString()
    #   # }"),
    #   format = colFormat(separators = TRUE, digits = 0)
    # ),
    # 
    # Pending = colDef(
    #   name = "Referrals Unassigned (No Visits Linked)",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = "sum",
    #   # footer = JS("function(column, state) {
    #   #   let total = 0
    #   #   state.sortedData.forEach(function(row) {
    #   #     total += row[column.id]
    #   #   })
    #   #   return total.toFixed(0)
    #   # }"),
    #   format = colFormat(separators = TRUE, digits = 0),
    #   style = list(borderRight = "1.5px solid rgb(230, 230, 230)")
    # ),
    
    conversion_rate = colDef(
      name = "Conversion Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalPending = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalPending += row['Pending']
        })
        return (totalTotal - totalPending) / totalTotal
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['conversion_rate']
        if (value > 0.5) {
          var color = '#008000'
        } else if (value <= 0.5 ) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
    
    completion_rate = colDef(
      name = "Completion Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalArrived = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalArrived += row['Arrived']
        })
        return totalArrived / totalTotal
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['completion_rate']
        if (value > 0.5) {
          var color = '#008000'
        } else if (value <= 0.5 ) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
    
    expired_unassigned_perc = colDef(
      name = "Expired Referrals Unassigned Rate",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalExpiredUnassigned = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal += row['Total']
          totalExpiredUnassigned += row['expired_unassigned']
        })
        return totalExpiredUnassigned / totalTotal
      }"),
      # style = JS("function(rowInfo) {
      #   var value = rowInfo.row['completion_rate']
      #   if (value > 0.5) {
      #     var color = '#008000'
      #   } else if (value <= 0.5 ) {
      #     var color = '#e00000'
      #   } else {
      #     var color = '#000000'
      #   }
      #   return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      # }"),
      style = list(color = "#e00000", fontWeight = "bold"),
      format = colFormat(percent = TRUE, digits = 0)
    ),
 
    future_appts = colDef(
      name = "Active Unassigned Referrals with Potential Upcoming Appointments",
      minWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff")
    ),
    
    past_appts = colDef(
      name = "Active Unassigned Referrals with Potential COMPLETED Appointments",
      minWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = "sum",
      # footer = JS("function(column, state) {
      #   let total = 0
      #   state.sortedData.forEach(function(row) {
      #     total += row[column.id]
      #   })
      #   return total.toFixed(0)
      # }"),
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff")
    ),
    
    Arrived = colDef(
      show = F
    ),
    
    Pending = colDef(
      show = F
    ),
    
    expired_unassigned = colDef(
      show = F
    )
    
  ) # Close Columns
  
  ) # Close Reactable

```
<br/>
<br/>


```{r Referrals Trend Processing, echo = FALSE, warning = FALSE, message = FALSE}

mshs_sites <- c("MSBI", "MSDMG", "MSH- Ambulatory Care", "MSH-MSDFP",
                         "MSM", "MSUS", "MSW", "Network", "MSQ", "MSSN")


# Referrals Data by Month
  referrals_trend_site <- referral_vol %>%
    filter(ReceivedByDept != "*Unspecified") %>%
    filter(Class != "Outgoing") %>%
    filter(Status != "Denied") %>%
    filter(ProcedureName %!in% referrals_excl) %>%
    # filter(ReceivedBySite %in% mshs_sites) %>%
    filter(StartInstant < report_run_date & StartInstant >= as.Date("2022-09-01", "%Y-%m-%d")) %>%
    group_by(ReceivedBySite, createdMonthYear, ApptStatusFinal) %>%
    summarise(total_vol = n()) %>%
    pivot_wider(names_from = ApptStatusFinal,
                values_from = total_vol,
                values_fill = 0)

  referrals_trend_site <- referrals_trend_site %>%
    mutate(Total = sum(across(where(is.numeric))))

  referrals_trend_site <- referrals_trend_site %>%
    group_by(createdMonthYear) %>%
    bind_rows(summarise(.,
                      across(where(is.integer), sum),
                      across(where(is.character), ~"*MSHS"))) %>%
    mutate(conversion_rate = round((Total - Pending)/Total,2)*100,
           completion_rate = round(Arrived/Total,2)*100) %>%
    dplyr::select(ReceivedBySite, createdMonthYear, Total, Arrived,  Pending, conversion_rate, completion_rate)

  referrals_trend_site <- referrals_trend_site %>%
    mutate(createdMonthYear = format(as.yearmon(createdMonthYear, "%m-%Y"),"%Y-%m")) %>%
    arrange(createdMonthYear) %>%
    arrange(ReceivedBySite)
  
```


## Referrals Trend - Site{.tabset .tabset-fade .tabset-pills}
### Referrals Received
```{r Referrals received Trend, echo = FALSE, warning = FALSE, message = FALSE}
  
  map(unique(referrals_trend_site$ReceivedBySite), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "# of Referrals"), lineWidth = 3, min = 0),
    list(title = list(text = "% of Referrals Received"), min = -50,max=200,
           labels = list(format = '{value}%'),
           showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (referrals_trend_site %>% filter(ReceivedBySite == x))$createdMonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y/%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name   = "Referrals Received",
                data   = (referrals_trend_site %>% filter(ReceivedBySite == x))$Total,
                type = "column",
                                zones = list(list(value = 0,
                                  color = 'red')),
                color='#a5a7a5',
                marker = list(enabled= TRUE),
                dataLabels = list(enabled = TRUE, format='{point.y}')
                ) %>%
  hc_add_series(name   = "Conversion Rate",
                data   = (referrals_trend_site %>% filter(ReceivedBySite == x))$conversion_rate,
                 marker = list(enabled= TRUE), yAxis = 1,
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef',
                dataLabels = list(enabled = TRUE, format='{point.y}%')
                ) %>%
   hc_add_series(name   = "Completion Rate",
                data   = (referrals_trend_site %>% filter(ReceivedBySite == x))$completion_rate,
                 marker = list(enabled= TRUE), yAxis = 1,
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
    hc_title(text = paste0(x, " - Referrals Outcome"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
    # hc_subtitle(text = paste0("Includes Radiology and Rad Onc visits up to ",radiology_date,"<br> Based on visits from ",date_start," to ",date_end),
    #           align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```
<br/>
<br/>


### Referrals Sent
```{r Referrals Sent Trend, echo = FALSE, warning = FALSE, message = FALSE}

mshs_sites <- c("MSBI", "MSDMG", "MSH- Ambulatory Care", "MSH-MSDFP",
                         "MSM", "MSUS", "MSW", "Network", "MSQ", "MSSN")


# Referrals Data by Month
  referrals_trend_site_sent <- referral_vol %>%
    filter(ReceivedByDept != "*Unspecified") %>%
    filter(Class != "Outgoing") %>%
    filter(Status != "Denied") %>%
    filter(ProcedureName %!in% referrals_excl) %>%
    filter(StartInstant < report_run_date & StartInstant >= as.Date("2022-09-01", "%Y-%m-%d")) %>%
    group_by(SentBySite, createdMonthYear, ApptStatusFinal) %>%
    summarise(total_vol = n()) %>%
    pivot_wider(names_from = ApptStatusFinal,
                values_from = total_vol,
                values_fill = 0)

  referrals_trend_site_sent <- referrals_trend_site_sent %>%
    mutate(Total = sum(across(where(is.numeric))))

  referrals_trend_site_sent <- referrals_trend_site_sent %>%
    group_by(createdMonthYear) %>%
    bind_rows(summarise(.,
                      across(where(is.integer), sum),
                      across(where(is.character), ~"*MSHS"))) %>%
    mutate(conversion_rate = round((Total - Pending)/Total,2)*100,
           completion_rate = round(Arrived/Total,2)*100) %>%
    dplyr::select(SentBySite, createdMonthYear, Total, Arrived,  Pending, conversion_rate, completion_rate)

  referrals_trend_site_sent <- referrals_trend_site_sent %>%
    mutate(createdMonthYear = format(as.yearmon(createdMonthYear, "%m-%Y"),"%Y-%m")) %>%
    arrange(createdMonthYear) %>%
    arrange(SentBySite)
  
  
  map(unique(referrals_trend_site_sent$SentBySite), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "# of Referrals"), lineWidth = 3, min = 0),
    list(title = list(text = "% of Referrals Received"), min = -50,max=200,
           labels = list(format = '{value}%'),
           showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (referrals_trend_site_sent %>% filter(SentBySite == x))$createdMonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y/%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name   = "Referrals Sent",
                data   = (referrals_trend_site_sent %>% filter(SentBySite == x))$Total,
                type = "column",
                                zones = list(list(value = 0,
                                  color = 'red')),
                color='#a5a7a5',
                marker = list(enabled= TRUE),
                dataLabels = list(enabled = TRUE, format='{point.y}')
                ) %>%
  hc_add_series(name   = "Conversion Rate",
                data   = (referrals_trend_site_sent %>% filter(SentBySite == x))$conversion_rate,
                 marker = list(enabled= TRUE), yAxis = 1,
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef',
                dataLabels = list(enabled = TRUE, format='{point.y}%')
                ) %>%
   hc_add_series(name   = "Completion Rate",
                data   = (referrals_trend_site_sent %>% filter(SentBySite == x))$completion_rate,
                 marker = list(enabled= TRUE), yAxis = 1,
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
    hc_title(text = paste0(x, " - Referrals Outcome"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
    # hc_subtitle(text = paste0("Includes Radiology and Rad Onc visits up to ",radiology_date,"<br> Based on visits from ",date_start," to ",date_end),
    #           align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```
<br/>
<br/>


## Unassigned Referrals {.tabset .tabset-fade .tabset-pills}
### Referrals Received
```{r Received Unassigned Output, echo = FALSE, warning = FALSE, message = FALSE}

unassigned_output <- unassigned_referrals_appts_merged %>%
    filter(type != "") %>%
    arrange(ReferralEpicId, Patient_MRN) %>%
    rename(Upcoming_Appt_Dept = future_dept,
           Upcoming_Appt_DTTM = future_appt_dttm,
           Upcoming_Appt_Provider = future_appt_provider,
           Upcoming_Appt_Name = future_appt_name,
           Upcoming_Appt_ScheduledBy = future_appt_entry,
           Completed_Appt_Dept = past_dept,
           Completed_Appt_DTTM = past_appt_dttm,
           Completed_Appt_Provider = past_appt_provider,
           Completed_Appt_Name = past_appt_name,
           Completed_Appt_ScheduledBy = past_appt_entry)%>%
    mutate(Upcoming_Appt_DTTM = as.character(Upcoming_Appt_DTTM),
           Completed_Appt_DTTM = as.character(Completed_Appt_DTTM)) %>%
  dplyr::select(StartInstant, ReferralEpicId, Patient_MRN, ProcedureName, Class, Status, ReceivedBySite, ReferredToDepartmentSpecialty, 
                ReceivedByDept, ReceivedByProvider, Upcoming_Appt_Dept, Upcoming_Appt_DTTM, Upcoming_Appt_Provider, Upcoming_Appt_Name, Upcoming_Appt_ScheduledBy,
                Completed_Appt_Dept, Completed_Appt_DTTM, Completed_Appt_Provider, Completed_Appt_Name, Completed_Appt_ScheduledBy, type)


htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Data (Unassigned Referrals with Potential Upcoming Appointments)"),
      onclick = "Reactable.downloadDataCSV('unassigned-download-table', 'Unassigned Referrals Data')"
    ),

    reactable(
      unassigned_output %>%
        arrange(ReceivedBySite, ReferredToDepartmentSpecialty),
      style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    searchable = TRUE,
    
    groupBy = c("ReceivedBySite", "ReferredToDepartmentSpecialty", "ReceivedByDept"),
    elementId = "unassigned-download-table",
    
    columns = list(
    
    ReceivedBySite = colDef(
      # footer = "Total",
      # name = "Site",
      minWidth = 180),
    
    ReferredToDepartmentSpecialty = colDef(
      # footer = "Total",
      # name = "Specialty",
      minWidth = 180),
    
    ReceivedByDept = colDef(
      # footer = "Total",
      # name = "Department",
      minWidth = 180),
    
    ReceivedByProvider = colDef(
      # footer = "Total",
      # name = "Department",
      minWidth = 180),
    
    Patient_MRN = colDef(
      # footer = "Total",
      name = "Patient MRN"),
    
    StartInstant = colDef(
      # footer = "Total",
      name = "Referral Created Date"),
    
    ProcedureName = colDef(
      # footer = "Total",
      name = "Procedure Name"),
    
    Class = colDef(
      # footer = "Total",
      name = "Referral Class"),
    
    Status = colDef(
      # footer = "Total",
      name = "Referral Status"),
    
    Upcoming_Appt_Dept = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled Department"),
    
    Upcoming_Appt_DTTM = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled DateTime"),
    
    Upcoming_Appt_Provider = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled Provider"),
    
    Upcoming_Appt_Name = colDef(
      # footer = "Total",
      name = "Upcoming Appt Name"),
    
    Upcoming_Appt_ScheduledBy = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled By"),
    
    Completed_Appt_Dept = colDef(
      # footer = "Total",
      name = "Completed Appt Scheduled Department"),
    
    Completed_Appt_DTTM = colDef(
      # footer = "Total",
      name = "Completed Appt Scheduled DateTime"),
    
    Completed_Appt_Provider = colDef(
      # footer = "Total",
      name = "Completed Appt Scheduled Provider"),
    
    Completed_Appt_Name = colDef(
      # footer = "Total",
      name = "Completed Appt Name"),
    
    Completed_Appt_ScheduledBy = colDef(
      # footer = "Total",
      name = "Completed Appt Scheduled By"),
    
    type = colDef(
      # footer = "Total",
      name = "Type")
    
    )

    )
  )
)



```
<br/>
<br/>


### Referrals Sent
```{r Sent Unassigned Output, echo = FALSE, warning = FALSE, message = FALSE}

unassigned_output_sent <- unassigned_referrals_sent %>%
    filter(type != "") %>%
    arrange(ReferralEpicId, Patient_MRN) %>%
    rename(Upcoming_Appt_Dept = future_dept,
           Upcoming_Appt_DTTM = future_appt_dttm,
           Upcoming_Appt_Provider = future_appt_provider,
           Upcoming_Appt_Name = future_appt_name,
           Upcoming_Appt_ScheduledBy = future_appt_entry,
           Completed_Appt_Dept = past_dept,
           Completed_Appt_DTTM = past_appt_dttm,
           Completed_Appt_Provider = past_appt_provider,
           Completed_Appt_Name = past_appt_name,
           Completed_Appt_ScheduledBy = past_appt_entry)%>%
    mutate(Upcoming_Appt_DTTM = as.character(Upcoming_Appt_DTTM),
           Completed_Appt_DTTM = as.character(Completed_Appt_DTTM)) %>%
  dplyr::select(StartInstant, ReferralEpicId, Patient_MRN, ProcedureName, Class, Status,
                SentBySite, SentBySpecialty, SentByDept,
                ReceivedBySite, ReferredToDepartmentSpecialty, 
                ReceivedByDept, Upcoming_Appt_Dept, Upcoming_Appt_DTTM, Upcoming_Appt_Provider, Upcoming_Appt_Name, Upcoming_Appt_ScheduledBy,
                Completed_Appt_Dept, Completed_Appt_DTTM, Completed_Appt_Provider, Completed_Appt_Name, Completed_Appt_ScheduledBy, type)




htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Data (Unassigned Referrals with Potential Upcoming Appointments)"),
      onclick = "Reactable.downloadDataCSV('sent-unassigned-download-table', 'Unassigned Referrals Data')"
    ),

    reactable(
      unassigned_output_sent %>%
        arrange(SentBySite, SentBySpecialty, SentByDept, ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept),
      style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    searchable = TRUE,
    
    groupBy = c("SentBySite", "SentBySpecialty", "SentByDept"),
    elementId = "sent-unassigned-download-table",
    
    columns = list(
    
    SentBySite = colDef(
      # footer = "Total",
      # name = "Site",
      minWidth = 180),
    
    SentBySpecialty = colDef(
      # footer = "Total",
      # name = "Specialty",
      minWidth = 180),
    
    SentByDept = colDef(
      # footer = "Total",
      # name = "Department",
      minWidth = 180),
    
    ReceivedBySite = colDef(
      # footer = "Total",
      # name = "Site",
      minWidth = 180),
    
    ReferredToDepartmentSpecialty = colDef(
      # footer = "Total",
      # name = "Specialty",
      minWidth = 180),
    
    ReceivedByDept = colDef(
      # footer = "Total",
      # name = "Department",
      minWidth = 180),
    
Patient_MRN = colDef(
      # footer = "Total",
      name = "Patient MRN"),
    
    StartInstant = colDef(
      # footer = "Total",
      name = "Referral Created Date"),
    
    ProcedureName = colDef(
      # footer = "Total",
      name = "Procedure Name"),

Class = colDef(
      # footer = "Total",
      name = "Referral Class"),
    
    Status = colDef(
      # footer = "Total",
      name = "Referral Status"),
    
    Upcoming_Appt_Dept = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled Department"),
    
    Upcoming_Appt_DTTM = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled DateTime"),
    
    Upcoming_Appt_Provider = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled Provider"),
    
    Upcoming_Appt_Name = colDef(
      # footer = "Total",
      name = "Upcoming Appt Name"),
    
    Upcoming_Appt_ScheduledBy = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled By"),
    
    Completed_Appt_Dept = colDef(
      # footer = "Total",
      name = "Completed Appt Scheduled Department"),
    
    Completed_Appt_DTTM = colDef(
      # footer = "Total",
      name = "Completed Appt Scheduled DateTime"),
    
    Completed_Appt_Provider = colDef(
      # footer = "Total",
      name = "Completed Appt Scheduled Provider"),
    
    Completed_Appt_Name = colDef(
      # footer = "Total",
      name = "Completed Appt Name"),
    
    Completed_Appt_ScheduledBy = colDef(
      # footer = "Total",
      name = "Completed Appt Scheduled By"),
    
    type = colDef(
      # footer = "Total",
      name = "Type")
    
    )

    )
  )
)

```
<br/>
<br/>


## Referrals W/O Referred-To DEP
```{r Referrals without referred-to department, echo = FALSE, warning = FALSE, message = FALSE}

unassigned_referrals_no_dept <- referral_vol %>%
  filter(ReceivedByDept == "*Unspecified") %>%
  filter(Class != "Outgoing") %>%
  filter(Status != "Denied") %>%
  filter(ProcedureName %!in% referrals_excl) %>%
  filter(ApptStatusFinal == "Pending") %>%
  filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals
  group_by(ReferralEpicId, ProcedureName, StartInstant, ExpirationInstant, Patient_MRN,
           SentBySite, SentBySpecialty, SentByDept,
           ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept, ReceivedByDepID) %>%
  summarise(total = n()) %>%
  dplyr::select(-total) %>%
  mutate(exclude = case_when(str_detect(ProcedureName, "COLONOSCOPY|NUTRITION") ~ "Exclude",
                             TRUE ~ "")) %>%
  filter(exclude != "Exclude") %>%
  mutate(ExpirationInstant = as.character(ExpirationInstant))



# Unassigned Referrals with Potential Future Appts within Same SPECIALTY -------
unassigned_referrals_specialty_no_dept <- merge(unassigned_referrals_no_dept,
              future_appts %>% filter(appt_specialty == 1) %>%
                dplyr::select(MRN, DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, APPT_DTTM, APPT_ENTRY_USER_NAME_WID),
              by.x = c("Patient_MRN", "ReferredToDepartmentSpecialty"),
              by.y = c("MRN", "DEPT_SPECIALTY_NAME")) 

unassigned_referrals_future_appts_no_dept <- left_join(unassigned_referrals_no_dept, unassigned_referrals_specialty_no_dept)

unassigned_referrals_future_appts_no_dept <- unassigned_referrals_future_appts_no_dept %>%
  rename(future_dept = DEPARTMENT_NAME,
         future_appt_dttm = APPT_DTTM,
         future_appt_entry = APPT_ENTRY_USER_NAME_WID)


unassigned_referrals_future_appts_no_dept <- unassigned_referrals_future_appts_no_dept %>%
  mutate(type = case_when(!is.na(future_dept) ~ "Referrals without referred-to department with upcoming appointments within same specialty",
                          TRUE ~ ""))

unassigned_referrals_future_appts_no_dept$exclude <- NULL

# Table output
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Data (Referrals W/O Referred-To DEP with Potential Upcoming Appointments)"),
      onclick = "Reactable.downloadDataCSV('without-referred-to-download-table', 'Referrals without Referred-To DEP')"
    ),

    reactable(
      unassigned_referrals_future_appts_no_dept %>%
        filter(!is.na(future_dept)) %>%
        arrange(SentBySite, SentBySpecialty, SentByDept, ReceivedBySite, ReferredToDepartmentSpecialty, ReceivedByDept),
      style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    searchable = TRUE,
    
    groupBy = c("SentBySite", "SentBySpecialty", "SentByDept"),
    elementId = "without-referred-to-download-table",
    
    columns = list(
    
    SentBySite = colDef(
      # footer = "Total",
      # name = "Site",
      minWidth = 180),
    
    SentBySpecialty = colDef(
      # footer = "Total",
      # name = "Specialty",
      minWidth = 180),
    
    SentByDept = colDef(
      # footer = "Total",
      # name = "Department",
      minWidth = 180),
    
    ReceivedBySite = colDef(
      # footer = "Total",
      # name = "Site",
      minWidth = 180),
    
    ReferredToDepartmentSpecialty = colDef(
      # footer = "Total",
      # name = "Specialty",
      minWidth = 180),
    
    ReceivedByDept = colDef(
      # footer = "Total",
      # name = "Department",
      minWidth = 180),
    
Patient_MRN = colDef(
      # footer = "Total",
      name = "Patient MRN"),
    
    StartInstant = colDef(
      # footer = "Total",
      name = "Referral Created Date"),
    
    ProcedureName = colDef(
      # footer = "Total",
      name = "Procedure Name"),
    
    future_dept = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled Department"),
    
    future_appt_dttm = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled DateTime"),
    
    future_appt_entry = colDef(
      # footer = "Total",
      name = "Upcoming Appt Scheduled By"),
    
    type = colDef(
      # footer = "Total",
      minWidth = 300,
      name = "Type")
    
    )

    )
  )
)


```



