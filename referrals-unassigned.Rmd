---
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
    fig_width: 7
    fig_height: 6
---


<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>
<style>
.tocify {
color: black;
}
<!-- } -->
<!-- .tocify .tocify-header { -->
<!--     position: fixed; -->
<!--     <!-- top: 50px; --> -->
<!--     left: 50px; -->
<!--     width: 350px; -->
<!--     <!-- border: solid 3px black; --> -->
<!--     <!-- height: 200px; --> -->
<!--  border: none; -->
<!-- } -->
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>
<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #212070;
     }
</style>
<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}

# # Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 8000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  # library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
  library(RODBC)
  library(DBI)
  library(odbc)
  library(dbplyr)
  library(pool)
  library(emojifont)
})


```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================

# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )

# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors

MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}

# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 

  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color

# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)

# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order

MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}



# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Use in ggplot 
  # scale_color_MountSinai("main")

```


```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```



```{r Reporting Variables, echo = FALSE, warning = FALSE, message = FALSE}

report_run_date <- Sys.Date()
# report_run_date <- "2022-08-10"
reporting_week <- floor_date(as.Date(report_run_date, "%Y-%m-%d")-7, unit="week", week_start = 7)
reporting_week_prior <- floor_date(as.Date(report_run_date, "%Y-%m-%d")-14, unit="week", week_start = 7)
reporting_week_next <- floor_date(as.Date(report_run_date, "%Y-%m-%d"), unit="week", week_start = 7)

reporting_year <- format(as.Date(report_run_date), "%Y")
reporting_month <- format(as.Date(report_run_date), "%b")
reporting_monthNum <- format(as.Date(report_run_date), "%m")


```


```{r Import Referrals Data, echo = FALSE, warning = FALSE, message = FALSE}

# path <- "/nfs/data/Applications/Ambulatory/Data_Updated/"
# saveRDS(referral_vol, paste0(path,"referral_vol.rds"))

# referral_vol <- readRDS(paste0(path,"referral_vol.rds"))


# referral_vol <- readRDS("referral_vol (3).rds")

```


```{r Establish Oracle Connection, echo = FALSE, warning = FALSE, message = FALSE}

report_run_date <- Sys.Date()

# Connect to Database ----------------------------------------------------------
# conn1 <- dbPool(drv = odbc(), dsn = "Caboodle", timeout = 30)
conn1 <- dbConnect(odbc(),
                    Driver = "SQLServer",
                    # Server = "10.2.42.69", # old server
                    Server = "datahub-synapse.sql.azuresynapse.net",
                    database = "datahub_epic_dw",
                    UID = "MSS_USER",
                    PWD = "Apple_Bees456$",
                    Port = 1433)


conn2 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB SoYoun", timeout = 30)
conn3 <- dbConnect(odbc(), 
                  "Clarity_prod", 
                  uid = "kweons01" , 
                  pwd = "kweons01123$")

access_raw_tbl <- tbl(conn3, "MV_DM_PATIENT_ACCESS")

# Caboodle
# referrals_conn <- tbl(conn1, "ReferralsDataView")
referrals_conn <- tbl(conn1, dbplyr::ident_q('"Caboodle"."ReferralsDataView"'))

# referralFact_conn <- tbl(conn1, "ReferralFact")
referralFact_conn <- tbl(conn1, dbplyr::ident_q('"Caboodle"."ReferralFact"'))

# visitFact_conn <- tbl(conn1, "VisitFact")
visitFact_conn <- tbl(conn1, dbplyr::ident_q('"Caboodle"."VisitFact"'))


# Clarity
referrals_tbl <- tbl(conn3, "REFERRAL")
referrals_wq_item_tbl <- tbl(conn3, "REFERRAL_WQ_ITEMS")
referrals_wq_tbl <- tbl(conn3, "REFERRAL_WQ")

```


```{r Referral Exclusion,  echo = FALSE, warning = FALSE, message = FALSE}

#Referral Orders to Exclude from Conversion Reporting
#Last Updated: 03.11.2025
# Referral Orders Excluded

ref_exclude <- c(
  "AMB REF TO ACUPUNCTURE",
  "AMB REF TO ADOL HEALTH COLPOSCOPY",
  "AMB REF TO ADOL HEALTH ENDOCRINE",
  "AMB REF TO ADOL HEALTH FITNESS SOCIAL WORK",
  "AMB REF TO ADOL HEALTH HEALTH EDUCATION",
  "AMB REF TO ADOL HEALTH HIV PRE TEST",
  "AMB REF TO ADOL HEALTH NUTRITION",
  "AMB REF TO ADOL HEALTH PRIMARY CARE SW",
  "AMB REF TO ADOL HEALTH PROJECT IMPACT",
  "AMB REF TO ADOL HEALTH PSYCHIATRY",
  "AMB REF TO AHC GENERAL DENTAL",
  "AMB REF TO AHC HEALTH NUTRITION",
  "AMB REF TO AHC LARC",
  "AMB REF TO AHC LEGAL HEALTH CLINIC",
  "AMB REF TO AHC MENTAL HEALTH",
  "AMB REF TO AHC OPTOMETRY",
  "AMB REF TO AHC ORAL SURGERY",
  "AMB REF TO AHC PEDS GI",
  "AMB REF TO AHC PSYCHOLOGY",
  "AMB REF TO AHC PSYCHOLOGY TESTING",
  "AMB REF TO ALCOHOL ADDICTION LIVER CLINIC",
  "AMB REF TO ALCOHOL/DRUG USE CLINIC",
  "AMB REF TO ALLERGY & CLIN IMM (FPA ASTHMA)",
  "AMB REF TO AMBULATORY BP MONITORING",
  "AMB REF TO ANESTHESIOLOGY",
  "AMB REF TO APHERESIS",
  "AMB REF TO APHERESIS - CELL COLLECTION ALLOGENEIC",
  "AMB REF TO APHERESIS - CELL COLLECTION AUTOLOGOUS",
  "AMB REF TO BACK AND NECK CENTER OF EXCELLENCE",
  "AMB REF TO BH SCREENING COLONOSCOPY",
  "AMB REF TO CAPSULE ENDOSCOPY",
  "AMB REF TO CARDIAC CATH (NS)",
  "AMB REF TO CARDIAC REHAB",
  "AMB REF TO CARDIOTHORACIC SURGERY",
  "AMB REF TO CARE MANAGEMENT",
  "AMB REF TO CHIROPRACTOR",
  "AMB REF TO CHRONIC CARE MANAGEMENT",
  "AMB REF TO CKD TEACHING/EDUCATION",
  "AMB REF TO CO INFECTION CLINIC",
  "AMB REF TO COGNITIVE NEUROLOGY",
  "AMB REF TO COLONOSCOPY (SCREENING)",
  "AMB REF TO COLONOSCOPY,DIAGNOSTIC",
  "AMB REF TO COLPOSCOPY",
  "AMB REF TO COMMUNITY PARAMEDICINE",
  "AMB REF TO CONDITION MANAGEMENT PROGRAM - REMOTE PATIENT MONITORING",
  "AMB REF TO CONSULT WORKERS COMPENSATION/SELIKOFF CENTER FOR OCCUPATIONAL HEALTH",
  "AMB REF TO COUMADIN CLINIC",
  "AMB REF TO COVID-19 FOLLOW UP",
  "AMB REF TO COVID-19 TESTING (SYMPTOMATIC ONLY)",
  "AMB REF TO COVID-19 THERAPEUTIC INFUSION",
  "AMB REF TO CYSTIC FIBROSIS",
  "AMB REF TO DENTISTRY",
  "AMB REF TO DENTISTRY (OB)",
  "AMB REF TO DIABETES ALLIANCE",
  "AMB REF TO DIABETES CARE PROGRAM",
  "AMB REF TO DIABETIC EDUCATOR",
  "AMB REF TO DUBIN PSYCHOLOGY",
  "AMB REF TO ENV & OCC MED (FPA ASTHMA PROG)",
  "AMB REF TO ESTHETICIAN",
  "AMB REF TO EXTERNAL BEHAVIORAL HEALTH (RAP NETWORK)",
  "AMB REF TO EXTERNAL DENTAL",
  "AMB REF TO EXTERNAL EARLY INTERVENTION",
  "AMB REF TO EXTERNAL OCCUPATIONAL THERAPY",
  "AMB REF TO EXTERNAL PHYSICAL THERAPY",
  "AMB REF TO EXTERNAL SPEECH THERAPY",
  "AMB REF TO FAMILY PLANNING",
  "AMB REF TO FETAL ECHO",
  "AMB REF TO FEU",
  "AMB REF TO FPA SELIKOFF OCCUPATIONAL HEALTH",
  "AMB REF TO FPA SOCIAL WORK",
  "AMB REF TO GASTROENTEROLOGY (FPA ASTHMA)",
  "AMB REF TO GERIATRIC PSYCHIATRY",
  "AMB REF TO GYNECOLOGY",
  "AMB REF TO HAND THERAPY",
  "AMB REF TO HOME PALLIATIVE CARE",
  "AMB REF TO HOME RADIOLOGY",
  "AMB REF TO HOSPICE CARE",
  "AMB REF TO IBD MALNUTRITION",
  "AMB REF TO IMA BEHAVIORAL HEALTH (DEPRESSION CARE + IMA PSYCH + IMA EVAL)",
  "AMB REF TO IMA DIABETES EDUCATOR",
  "AMB REF TO IMA LONG COVID CLINIC",
  "AMB REF TO IMA NEPHROLOGY",
  "AMB REF TO IMA NUTRITION",
  "AMB REF TO IMA PHARMACIST",
  "AMB REF TO INFERTILITY PRACTICE",
  "AMB REF TO INSTITUTE FOR LIVER MEDICINE NUTRITION",
  "AMB REF TO INTERVENTIONAL RADIOLOGY",
  "AMB REF TO INTESTINAL TRANSPLANT",
  "AMB REF TO JMF",
  "AMB REF TO JMF GYN",
  "AMB REF TO JMF NEUROLOGY",
  "AMB REF TO JMF PAIN MANAGEMENT",
  "AMB REF TO JMF PSYCHIATRY",
  "AMB REF TO JMF RENAL",
  "AMB REF TO JMFC",
  "AMB REF TO KIDNEY & PANCREAS TRANSPLANT",
  "AMB REF TO LEAP",
  "AMB REF TO LIGHTHOUSE OPHTHALMOLOGY",
  "AMB REF TO MASSAGE THERAPY",
  "AMB REF TO MENTAL HEALTH INITIAL",
  "AMB REF TO MFM",
  "AMB REF TO MFMA CONSULTATIVE SERVICES",
  "AMB REF TO MFMA EVALUATION UNIT",
  "AMB REF TO MOUNT SINAI FIT SMOKING CESSATION",
  "AMB REF TO MSD FOREST HILLS CARDIOMETABOLIC WELLNESS PROGRAM",
  "AMB REF TO MSH NETWORK CHF DISEASE MANAGEMENT PROGRAM",
  "AMB REF TO MSQ EXPRESS CARE",
  "AMB REF TO MSS TOTAL JOINT REPLACEMENT COE",
  "AMB REF TO MSSN DIABETES EDUCATION",
  "AMB REF TO MSSN PRE-OP CLEARANCE",
  "AMB REF TO NEURO BEHAVIORAL CLINIC",
  "AMB REF TO NEUROPHYS/PSYCH",
  "AMB REF TO NOOM",
  "AMB REF TO NURSING ADHERENCE VISIT",
  "AMB REF TO NUTRITION",
  "AMB REF TO NUTRITION CVI CLINIC",
  "AMB REF TO NYS SMOKING CESSATION",
  "AMB REF TO OB BOOKING",
  "AMB REF TO OCCUPATIONAL THERAPY",
  "AMB REF TO ONCOLOGY CLINICAL TRIALS",
  "AMB REF TO ONCOLOGY NUTRITION",
  "AMB REF TO ORTHOTICS",
  "AMB REF TO OTOLARYNGOLOGY",
  "AMB REF TO PACEMAKER CLINIC",
  "AMB REF TO PATHOLOGY",
  "AMB REF TO PEDIATRIC SOCIAL WORK/MENTAL HEALTH",
  "AMB REF TO PEDIATRICS ENVIRONMENTAL",
  "AMB REF TO PEDS ASTHMA FOLLOW UP",
  "AMB REF TO PEDS CHILD DEVELOP",
  "AMB REF TO PEDS CHILD/FAM SUP",
  "AMB REF TO PEDS DENTAL",
  "AMB REF TO PEDS EARLY INTER.",
  "AMB REF TO PEDS GENETICS",
  "AMB REF TO PEDS HEMATOLOGY",
  "AMB REF TO PEDS OCCUP THERAPY",
  "AMB REF TO PEDS PHYS THERAPY",
  "AMB REF TO PEDS PSYCHIATRY",
  "AMB REF TO PEDS PSYCHOLOGY",
  "AMB REF TO PEDS SPEECH THERAPY",
  "AMB REF TO PHARMACOGENETICS",
  "AMB REF TO PHARMACY",
  "AMB REF TO PHYSICAL THERAPY",
  "AMB REF TO PREP",
  "AMB REF TO PRE-PROCEDURE COVID-19 TESTING (ASYMPTOMATIC ONLY)",
  "AMB REF TO PRIMARY CARE_SPECIALTY USE ONLY",
  "AMB REF TO PROSTHETICS",
  "AMB REF TO PSYCHIATRY",
  "AMB REF TO PSYCHIATRY (FPA ASTHMA PROGRAM)",
  "AMB REF TO PSYCHIATRY (PAS ONLY)",
  "AMB REF TO PSYCHOLOGY",
  "AMB REF TO PULMONARY FUNCTION LAB",
  "AMB REF TO PULMONARY HYPERTENSION",
  "AMB REF TO RAD ONCOLOGY",
  "AMB REF TO RAINBOW CLINIC",
  "AMB REF TO REACH PROGRAM(FOR SUBSTANCE USE AND/OR HEPATITUS C TREATMENT",
  "AMB REF TO REGISTERED DIETICIAN",
  "AMB REF TO REHAB PHASE II",
  "AMB REF TO REHAB/MODIFIED BARIUM STUDY",
  "AMB REF TO RMA REPRODUCTIVE ENDOCRINOLOGY",
  "AMB REF TO RN-LED HTN MANAGEMENT CLINIC",
  "AMB REF TO SELIKOFF SMOKING CESSATION PROGRAM",
  "AMB REF TO SICKLE CELL",
  "AMB REF TO SOCIAL WORK",
  "AMB REF TO SPECIALTY SOCIAL WORK",
  "AMB REF TO SPEECH THERAPY",
  "AMB REF TO SPIRITUAL CARE",
  "AMB REF TO SPORTS CONCUSSION",
  "AMB REF TO SPORTS FELLOWSHIP",
  "AMB REF TO SUPPORTIVE CARDIOLOGY",
  "AMB REF TO SW FOR HIV COUNS/TEST",
  "AMB REF TO SW MH SERVICES",
  "AMB REF TO THORACIC DISEASES",
  "AMB REF TO TOP (EXTERNAL)",
  "AMB REF TO TRANSPLANT HBIG INFUSION",
  "AMB REF TO UPPER ENDOSCOPY",
  "AMB REF TO UROLOGY-INCONTINENCE",
  "AMB REF TO VIRTUAL MED MANAGEMENT",
  "AMB REF TO VISITING DOCTORS",
  "AMB REF TO VISITING NURSE SERVICE",
  "AMB REF TO VOCATIONAL THERAPY",
  "AMB REF TO WHEELCHAIR CLINIC",
  "AMB REF TO WOMEN, INFANT & CHILDREN'S FOOD SUPPLEMENT PROGRAM",
  "AMB REF TO WOMEN'S HEALTH FPA",
  "AMB REFERRAL TO PRECISION RECOVERY",
  "AMB REFERRAL TO VASCULAR ACCESS SERVICE",
  "AMBULATORY REFERRAL TO ED",
  "APPOINTMENT AFTER ECONSULT",
  "APRETUDE AUTHORIZATION REFERRAL",
  "CABENUVA AUTHORIZATION REFERRAL",
  "CARE MANAGEMENT REFERRAL FOR EXTERNAL SERVICES",
  "IP SOCIAL WORK CONSULT TO CORAM CVS/SPECIALTY INFUSION SERVICES",
  "MS AMB REF TO MIDI (EXTERNAL)",
  "MSSN SURGICAL BOOKING ORDER",
  "PHX REFERRAL TO LUNG TRANSPLANT",
  "REFERRAL NUCLEAR STRESS TEST"

)

```


```{r Referrals- Caboodle ReferralsDataView, echo = FALSE, warning = FALSE, message = FALSE}

rfl_visits_linked <- visitFact_conn %>%
  filter(ReferralKey>0) %>%
  group_by(ReferralKey, EncounterEpicCsn, AppointmentStatus, `_LastUpdatedInstant`) %>% 
  summarise(total = n()) %>%
  group_by(EncounterEpicCsn) %>%
  filter(`_LastUpdatedInstant` == max(`_LastUpdatedInstant`, na.rm = TRUE)) %>%
  dplyr::select(ReferralKey, EncounterEpicCsn, AppointmentStatus) %>%
  group_by(ReferralKey) %>%
  summarise(num_appts_sched = n_distinct(EncounterEpicCsn),
            num_appts_comp = n_distinct(EncounterEpicCsn[AppointmentStatus %in% c("Completed", "Arrived", "Checked In", "Finalized", "Checked Out")])) %>%
  mutate(sched_flag = case_when(num_appts_sched > 0 ~ "Y", TRUE ~ "N"),
         comp_flag = case_when(num_appts_comp >0 ~ "Y", TRUE ~ "N")) 


referrals_merged <- referrals_conn %>%
  filter(!(ProcedureName %in% ref_exclude)) %>%
  # filter(ReceivedByDept != "*Unspecified") %>%
  filter(Status != "Denied") %>%
  filter(Class != "Outgoing") %>%
  dplyr::select(-c("AppointmentCreationDateKey", 
                   "AppointmentCreationDate",
                   "AppointmentDateKey",
                    "AppointmentTimeOfDayKey",
                    "Appt_Date",
                    "Appt_Time",
                    "AppointmentDateTime",
                    "EncounterEpicCsn",
                    "Scheduled_in_DeptName",
                    "Scheduled_in_DeptID",
                    "AppointmentStatus",
                    "AppointmentEntryEmployee",
                    "AppointmentEntryEmployeeName")) %>%
  distinct() %>%
  left_join(rfl_visits_linked, 
            by = c("ReferralKey")) 



referrals_processed <- referrals_merged %>%
  mutate(Creation_Date = as.Date(Creation_Date)) %>%
  filter(Creation_Date >= as.Date("2025-01-01") & Creation_Date < report_run_date) %>%
  # mutate(createdWeek = floor_date(as.Date(Creation_Date, "%Y-%m-%d"), unit="week", week_start = 7),
  #        createdYear = format(as.Date(Creation_Date, "%Y-%m-%d"),"%Y"),
  #        createdMonNum = as.numeric(format(as.Date(Creation_Date, "%Y-%m-%d"),"%m")),
  #        createdMonth = format(as.Date(Creation_Date, "%Y-%m-%d"),"%B"),
  #        createdMonthYear = format(as.Date(Creation_Date, "%Y-%m-%d"),"%m-%Y")) %>%
  mutate(priority_type = case_when(toupper(Priority) %like% "%CONVENIENCE%" ~ "Patient Convenience",
                                   toupper(Priority) %like% "%2 DAYS%" ~ "Within 2 Days",
                                   toupper(Priority) %like% "%1 WEEK%" ~ "Within 1 Week",
                                   toupper(Priority) %like% "%2 WEEKS%" ~ "Within 2 Weeks",
                                   toupper(Priority) %like% "%3-6 Days%" ~ "Within 1 Week",
                                   toupper(Priority) %like% "%7-14 Days%" ~ "Within 2 Weeks",
                                   Priority == "Routine" ~ "Routine",
                                   TRUE ~ "Not Specified")) %>%
  collect()

```


```{r Merge Referrals with Scheduling Data, echo = FALSE, warning = FALSE, message = FALSE}

# Connection to Oracle DB ------------------------------------------------------
# conn1 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB SoYoun", timeout = 30)
conn2 <- dbConnect(odbc(), 
                  "Clarity_prod", 
                  uid = "kweons01" , 
                  pwd = "kweons01123$")

# Import Slot Availability Data ------------------------------------------------
# slot_raw_tbl <- tbl(conn1, "Y_DM_BOOKED_FILLED_RATE")
access_raw_tbl <- tbl(conn2, "MV_DM_PATIENT_ACCESS")

appt_not_linked <- access_raw_tbl %>%
  filter(is.na(REFERRAL_ID)) %>%
  filter(APPT_MADE_DATE >= as.Date("2025-01-01")) %>%
  dplyr::select(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_NAME_WID, 
                MRN, PAT_NAME, PAT_ENC_CSN_ID, APPT_ENTRY_USER_NAME_WID, APPT_MADE_DTTM, APPT_DTTM, CONTACT_DATE, PRC_NAME, APPT_STATUS_NAME) %>%
  collect()


rfl_same_spec <- referrals_processed %>%
  filter(is.na(sched_flag)) %>%
  dplyr::select(Creation_Date, ReferralEpicId, Patient_MRN, ProcedureName, Class, Status,
                SentBySite, SentBySpecialty, SentByDept,
                ReceivedBySite, ReceivedBySpecialtyFromDepDim, ReceivedByDept, ReceivedByDepID,
                ReceivedByProvider) %>%
  left_join(appt_not_linked,
            by = c("Patient_MRN" = "MRN")) %>%
  mutate(same_specialty = case_when(ReceivedBySpecialtyFromDepDim == DEPT_SPECIALTY_NAME ~ "Y", TRUE ~ "N"),
         same_dept = case_when(ReceivedByDepID == DEPARTMENT_ID ~ "Y", TRUE ~ "N")) %>%
  filter(same_specialty == "Y" | same_dept == "Y") %>%
  mutate(lead_days = as.Date(CONTACT_DATE) - as.Date(Creation_Date)) %>%
  mutate(same_spec = case_when(lead_days <= 180 & lead_days >= -180 ~ "Y", TRUE ~ "N")) %>%
  filter(same_spec == "Y") %>%
  arrange(ReferralEpicId, APPT_DTTM) 
  


# check <- rfl_same_spec %>% filter(Patient_MRN == "4767887") %>%
#   dplyr::select(ReferralKey, SentByDept, ReceivedBySite, ReceivedByDept, ReceivedByDepID, ReceivedBySpecialty,
#                 Creation_Date, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, APPT_MADE_DTTM, APPT_DTTM, APPT_STATUS_NAME, same_spec, same_specialty, same_dept)
  
```

```{r}

# referral_summary <- referrals_processed %>%
#   filter(ReceivedByDept != "*Unspecified") %>%
#   mutate(start_year = year(Creation_Date),
#          start_month = month(Creation_Date)) %>%
#   group_by(start_year, start_month) %>%
#   summarise(non_converted = n_distinct(ReferralEpicId[is.na(sched_flag)]),
#             scheduled = n_distinct(ReferralEpicId[sched_flag == "Y"]),
#             completed = n_distinct(ReferralEpicId[comp_flag == "Y"])) 
# 
# 
# missing_dept_summary2 <- referrals_processed %>%
#   filter(ReceivedByDept == "*Unspecified") %>%
#   mutate(start_year = year(Creation_Date),
#          start_month = month(Creation_Date)) %>%
#   group_by(start_year, start_month) %>%
#   summarise(no_dept = n_distinct(ReferralEpicId)) 


```



```{r Sinai Logo, echo=FALSE, out.width = '30%'}
knitr::include_graphics("Mount_Sinai_Logo_H.png")
```


# Ambulatory Unassigned Referrals Report
*Report Run Date: `r report_run_date`*<br/>
*Data Date Range: From 2024-01-01 to `r report_run_date - 1`*<br/>
*Data Source: EPIC Caboodle Referrals Data and Clarity Scheduling Data*<br/>
*Active unassigned referrals with potential upcoming visits excludes expired referrals and referrals with potential upcoming appointments scheduled for after referral expiration date*<br/>
*Excludes Nutrition and Colonoscopy referrals*<br/>
*Excludes referrals that do not result in appointments (e.g. social work, spiritual care, education, etc)*<br/>
*Excludes "Outgoing" and "Denied" referrals*<br/>

:::: {.blackbox data-latex=""}
::: {.center data-latex=""}
<span style='font-size: 18px;; color: #d80b8c'>**Metric Definitions:**</span>
<br/>
<span style='font-size: 16px;'>-- **Conversion Rate:** Total referrals with **scheduled visits** over total referrals received</span><br/>
<span style='font-size: 16px;'>-- **Completion Rate:** Total referrals with **arrived visits** over total referrals received</span><br/>
<span style='font-size: 16px;'>-- **Expired Unassigned Rate:** Total referrals expired with **no visits linked** over total referrals received</span><br/>
<span style='font-size: 16px;'>-- **Unassigned Referrals:** Total referrals with **no visits linked** over total referrals received</span>
<br/>
:::
::::


<!-- ```{r Referrals Received Processing, echo = FALSE, warning = FALSE, message = FALSE} -->

<!-- referrals_summary_site <- referral_vol %>% -->
<!--   filter(ReceivedByDept != "*Unspecified") %>% -->
<!--   filter(Class != "Outgoing") %>% -->
<!--   filter(Status != "Denied") %>% -->
<!--   filter(ProcedureName %!in% referrals_excl) %>% -->
<!--   group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ApptStatusFinal) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   pivot_wider(names_from = ApptStatusFinal, -->
<!--               values_from = total, -->
<!--               values_fill = 0) %>% -->
<!--   adorn_totals("row", "Total") %>% # Row for MSHS Total   -->
<!--   group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>% -->
<!--   mutate(Total = sum(across(where(is.numeric)))) %>% -->
<!--   mutate(conversion_rate = round((Total - Pending)/Total ,2), -->
<!--          completion_rate = round(Arrived/Total, 2), -->
<!--          unassigned_perc = round(Pending/ Total,2)) -->

<!-- expired_summary_site <- referral_vol %>% -->
<!--   filter(ReceivedByDept != "*Unspecified") %>% -->
<!--   filter(Class != "Outgoing") %>% -->
<!--   filter(Status != "Denied") %>% -->
<!--   filter(ProcedureName %!in% referrals_excl) %>% -->
<!--   filter(ExpirationInstant < report_run_date) %>% -->
<!--   group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ApptStatusFinal) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   pivot_wider(names_from = ApptStatusFinal, -->
<!--               values_from = total, -->
<!--               values_fill = 0) %>% -->
<!--   adorn_totals("row", "Total") %>% -->
<!--   group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>% -->
<!--   mutate(Total = sum(across(where(is.numeric)))) %>% -->
<!--   dplyr::select(ReceivedBySite, ReferredToDepartmentSpecialty, Pending) %>% -->
<!--   rename(expired_unassigned = Pending) -->

<!-- referrals_summary_site <- left_join(referrals_summary_site, expired_summary_site) -->
<!-- referrals_summary_site <- referrals_summary_site %>% -->
<!--   mutate(expired_unassigned_perc = round(expired_unassigned/Total,2)) -->

<!-- unassigned_referrals_future_appts_summary <- unassigned_referrals_appts_merged %>% -->
<!--   filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals -->
<!--   filter(!is.na(future_dept)) %>% -->
<!--   group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ReferralEpicId) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>% -->
<!--   summarise(future_appts = n()) %>% -->
<!--   adorn_totals("row", "Total")  -->

<!-- referrals_summary_site <- merge(referrals_summary_site, unassigned_referrals_future_appts_summary) -->

<!-- unassigned_referrals_past_appts_summary <- unassigned_referrals_appts_merged %>% -->
<!--   filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals -->
<!--   filter(is.na(future_dept)) %>% -->
<!--   filter(!is.na(past_dept)) %>% -->
<!--   group_by(ReceivedBySite, ReferredToDepartmentSpecialty, ReferralEpicId) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   group_by(ReceivedBySite, ReferredToDepartmentSpecialty) %>% -->
<!--   summarise(past_appts = n()) %>% -->
<!--   adorn_totals("row", "Total")  -->

<!-- referrals_summary_site <- merge(referrals_summary_site, unassigned_referrals_past_appts_summary)   -->

<!-- # referrals_summary_site <- referrals_summary_site %>% -->
<!-- #   mutate(unassigned_appts_perc = round(future_appts/Pending,2))  -->

<!-- referrals_summary_site[is.na(referrals_summary_site)] <- 0 -->

<!-- ``` -->


<!-- ```{r Referrals Sent Processing, echo = FALSE, warning = FALSE, message = FALSE} -->


<!-- referrals_summary_site_sent <- referral_vol %>% -->
<!--   filter(ReceivedByDept != "*Unspecified") %>% -->
<!--   filter(Class != "Outgoing") %>% -->
<!--   filter(Status != "Denied") %>% -->
<!--   filter(ProcedureName %!in% referrals_excl) %>% -->
<!--   group_by(SentBySite, SentBySpecialty, ApptStatusFinal) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   pivot_wider(names_from = ApptStatusFinal, -->
<!--               values_from = total, -->
<!--               values_fill = 0) %>% -->
<!--   adorn_totals("row", "Total") %>% -->
<!--   group_by(SentBySite, SentBySpecialty) %>% -->
<!--   mutate(Total = sum(across(where(is.numeric)))) %>% -->
<!--   mutate(conversion_rate = round((Total - Pending)/Total ,2), -->
<!--          completion_rate = round(Arrived/Total, 2), -->
<!--          unassigned_perc = round(Pending/ Total,2)) -->

<!-- expired_summary_site_sent <- referral_vol %>% -->
<!--   filter(ReceivedByDept != "*Unspecified") %>% -->
<!--   filter(Class != "Outgoing") %>% -->
<!--   filter(Status != "Denied") %>% -->
<!--   filter(ProcedureName %!in% referrals_excl) %>% -->
<!--   filter(ExpirationInstant < report_run_date) %>% -->
<!--   group_by(SentBySite, SentBySpecialty, ApptStatusFinal) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   pivot_wider(names_from = ApptStatusFinal, -->
<!--               values_from = total, -->
<!--               values_fill = 0) %>% -->
<!--   adorn_totals("row", "Total") %>% -->
<!--   group_by(SentBySite, SentBySpecialty) %>% -->
<!--   mutate(Total = sum(across(where(is.numeric)))) %>% -->
<!--   dplyr::select(SentBySite, SentBySpecialty, Pending) %>% -->
<!--   rename(expired_unassigned = Pending) -->

<!-- referrals_summary_site_sent <- left_join(referrals_summary_site_sent, expired_summary_site_sent) -->
<!-- referrals_summary_site_sent <- referrals_summary_site_sent %>% -->
<!--   mutate(expired_unassigned_perc = round(expired_unassigned/Total,2)) -->

<!-- unassigned_referrals_future_appts_summary_sent <- unassigned_referrals_sent %>% -->
<!--   filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals -->
<!--   filter(!is.na(future_dept)) %>% -->
<!--   group_by(SentBySite, SentBySpecialty, ReferralEpicId) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   group_by(SentBySite, SentBySpecialty) %>% -->
<!--   summarise(future_appts = n()) %>% -->
<!--   adorn_totals("row", "Total")  -->

<!-- referrals_summary_site_sent <- merge(referrals_summary_site_sent, unassigned_referrals_future_appts_summary_sent) -->

<!-- unassigned_referrals_past_appts_summary_sent <- unassigned_referrals_sent %>% -->
<!--   filter(ExpirationInstant > report_run_date) %>% # Remove expired referrals -->
<!--   filter(is.na(future_dept)) %>% -->
<!--   filter(!is.na(past_dept)) %>% -->
<!--   group_by(SentBySite, SentBySpecialty, ReferralEpicId) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   group_by(SentBySite, SentBySpecialty) %>% -->
<!--   summarise(past_appts = n()) %>% -->
<!--   adorn_totals("row", "Total")  -->

<!-- referrals_summary_site_sent <- merge(referrals_summary_site_sent, unassigned_referrals_past_appts_summary_sent)   -->

<!-- # referrals_summary_site <- referrals_summary_site %>% -->
<!-- #   mutate(unassigned_appts_perc = round(future_appts/Pending,2))  -->

<!-- referrals_summary_site_sent[is.na(referrals_summary_site_sent)] <- 0 -->

<!-- ``` -->


<!-- ## Referrals Summary - Site{.tabset .tabset-fade .tabset-pills} -->
<!-- ### Referrals Received -->
<!-- ```{r Referrals Received Output, echo = FALSE, warning = FALSE, message = FALSE} -->

<!-- reactable( -->
<!--   referrals_summary_site %>% -->
<!--     dplyr::select(ReceivedBySite, ReferredToDepartmentSpecialty, Total, Arrived, Pending,  -->
<!--                   conversion_rate, completion_rate, expired_unassigned, expired_unassigned_perc, future_appts, past_appts), -->
<!--   style = list(fontFamily = 'Calibri', -->
<!--                  fontSize = '14px'), -->
<!--     defaultColDef = colDef(align = "left",  -->
<!--                            headerStyle = list(fontWeight = "Bold", fontSize = "14px"), -->
<!--                            headerClass = "bar-sort-header"), -->
<!--     highlight = TRUE, -->
<!--     # filterable = TRUE, -->
<!--     pagination = FALSE, -->
<!--     # height = 800, -->
<!--     wrap = TRUE, -->

<!--   rowStyle = function(index) { -->
<!--             if (index %in% c(length(unique(referrals_summary_site$ReceivedBySite)))) { -->
<!--               list(`border-top` = "2px solid rgb(184,184,184)", -->
<!--                    fontWeight = "Bold") -->
<!--             } -->
<!--           }, -->

<!--   groupBy = c("ReceivedBySite", "ReferredToDepartmentSpecialty"), -->


<!--   columns = list( -->

<!--     ReceivedBySite = colDef( -->
<!--       # footer = "Total", -->
<!--       name = "Site", -->
<!--       minWidth = 180), -->

<!--     ReferredToDepartmentSpecialty = colDef( -->
<!--       # footer = "Total", -->
<!--       name = "Specialty", -->
<!--       minWidth = 180), -->

<!--     Total = colDef( -->
<!--       name = "Total Referrals Received", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = "sum", -->
<!--       # footer = JS("function(column, state) { -->
<!--       #   let total = 0 -->
<!--       #   state.sortedData.forEach(function(row) { -->
<!--       #     total += row[column.id] -->
<!--       #   }) -->
<!--       #   return total.toFixed(0) -->
<!--       # }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0), -->
<!--       style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", borderRight = "1.5px solid rgb(230, 230, 230)") -->
<!--     ), -->

<!--     # Arrived = colDef( -->
<!--     #   name = "Referrals with Completed Appointments", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = "sum", -->
<!--     #   # footer = JS("function(column, state) { -->
<!--     #   #   let total = 0 -->
<!--     #   #   state.sortedData.forEach(function(row) { -->
<!--     #   #     total += row[column.id] -->
<!--     #   #   }) -->
<!--     #   #   return total.toFixed(0).toLocaleString() -->
<!--     #   # }"), -->
<!--     #   format = colFormat(separators = TRUE, digits = 0) -->
<!--     # ), -->
<!--     #  -->
<!--     # Pending = colDef( -->
<!--     #   name = "Referrals Unassigned (No Visits Linked)", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = "sum", -->
<!--     #   # footer = JS("function(column, state) { -->
<!--     #   #   let total = 0 -->
<!--     #   #   state.sortedData.forEach(function(row) { -->
<!--     #   #     total += row[column.id] -->
<!--     #   #   }) -->
<!--     #   #   return total.toFixed(0) -->
<!--     #   # }"), -->
<!--     #   format = colFormat(separators = TRUE, digits = 0), -->
<!--     #   style = list(borderRight = "1.5px solid rgb(230, 230, 230)") -->
<!--     # ), -->

<!--     conversion_rate = colDef( -->
<!--       name = "Conversion Rate", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalPending = 0 -->
<!--         let totalTotal = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalTotal += row['Total'] -->
<!--           totalPending += row['Pending'] -->
<!--         }) -->
<!--         return (totalTotal - totalPending) / totalTotal -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['conversion_rate'] -->
<!--         if (value > 0.5) { -->
<!--           var color = '#008000' -->
<!--         } else if (value <= 0.5 ) { -->
<!--           var color = '#e00000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 0) -->
<!--     ), -->

<!--     completion_rate = colDef( -->
<!--       name = "Completion Rate", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalArrived = 0 -->
<!--         let totalTotal = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalTotal += row['Total'] -->
<!--           totalArrived += row['Arrived'] -->
<!--         }) -->
<!--         return totalArrived / totalTotal -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['completion_rate'] -->
<!--         if (value > 0.5) { -->
<!--           var color = '#008000' -->
<!--         } else if (value <= 0.5 ) { -->
<!--           var color = '#e00000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 0) -->
<!--     ), -->

<!--     expired_unassigned_perc = colDef( -->
<!--       name = "Expired Referrals Unassigned Rate", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalExpiredUnassigned = 0 -->
<!--         let totalTotal = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalTotal += row['Total'] -->
<!--           totalExpiredUnassigned += row['expired_unassigned'] -->
<!--         }) -->
<!--         return totalExpiredUnassigned / totalTotal -->
<!--       }"), -->
<!--       # style = JS("function(rowInfo) { -->
<!--       #   var value = rowInfo.row['completion_rate'] -->
<!--       #   if (value > 0.5) { -->
<!--       #     var color = '#008000' -->
<!--       #   } else if (value <= 0.5 ) { -->
<!--       #     var color = '#e00000' -->
<!--       #   } else { -->
<!--       #     var color = '#000000' -->
<!--       #   } -->
<!--       #   return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       # }"), -->
<!--       style = list(color = "#e00000", fontWeight = "bold"), -->
<!--       format = colFormat(percent = TRUE, digits = 0) -->
<!--     ), -->

<!--     future_appts = colDef( -->
<!--       name = "Active Unassigned Referrals with Potential UPCOMING Appointments", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = "sum", -->
<!--       # footer = JS("function(column, state) { -->
<!--       #   let total = 0 -->
<!--       #   state.sortedData.forEach(function(row) { -->
<!--       #     total += row[column.id] -->
<!--       #   }) -->
<!--       #   return total.toFixed(0) -->
<!--       # }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0), -->
<!--       style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff") -->
<!--     ), -->

<!--     past_appts = colDef( -->
<!--       name = "Active Unassigned Referrals with Potential COMPLETED Appointments", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = "sum", -->
<!--       # footer = JS("function(column, state) { -->
<!--       #   let total = 0 -->
<!--       #   state.sortedData.forEach(function(row) { -->
<!--       #     total += row[column.id] -->
<!--       #   }) -->
<!--       #   return total.toFixed(0) -->
<!--       # }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0), -->
<!--       style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff") -->
<!--     ), -->

<!--     Arrived = colDef( -->
<!--       show = F -->
<!--     ), -->

<!--     Pending = colDef( -->
<!--       show = F -->
<!--     ), -->

<!--     expired_unassigned = colDef( -->
<!--       show = F -->
<!--     ) -->

<!--   ) # Close Columns -->

<!--   ) # Close Reactable -->

<!-- ``` -->
<!-- <br/> -->
<!-- <br/> -->


<!-- ### Referrals Sent -->
<!-- ```{r Referrals Sent Output, echo = FALSE, warning = FALSE, message = FALSE} -->

<!-- reactable( -->
<!--   referrals_summary_site_sent %>% -->
<!--     dplyr::select(SentBySite, SentBySpecialty, Total, Arrived, Pending,  -->
<!--                   conversion_rate, completion_rate, expired_unassigned, expired_unassigned_perc, future_appts, past_appts), -->
<!--   style = list(fontFamily = 'Calibri', -->
<!--                  fontSize = '14px'), -->
<!--     defaultColDef = colDef(align = "left",  -->
<!--                            headerStyle = list(fontWeight = "Bold", fontSize = "14px"), -->
<!--                            headerClass = "bar-sort-header"), -->
<!--     highlight = TRUE, -->
<!--     # filterable = TRUE, -->
<!--     pagination = FALSE, -->
<!--     # height = 800, -->
<!--     wrap = TRUE, -->

<!--   rowStyle = function(index) { -->
<!--             if (index %in% c(length(unique(referrals_summary_site_sent$SentBySite)))) { -->
<!--               list(`border-top` = "2px solid rgb(184,184,184)", -->
<!--                    fontWeight = "Bold") -->
<!--             } -->
<!--           }, -->

<!--   groupBy = c("SentBySite", "SentBySpecialty"), -->


<!--   columns = list( -->

<!--     SentBySite = colDef( -->
<!--       # footer = "Total", -->
<!--       name = "Sent Site", -->
<!--       minWidth = 180), -->

<!--     SentBySpecialty = colDef( -->
<!--       # footer = "Total", -->
<!--       name = "Sent Specialty", -->
<!--       minWidth = 180), -->

<!--     Total = colDef( -->
<!--       name = "Total Referrals Sent", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = "sum", -->
<!--       # footer = JS("function(column, state) { -->
<!--       #   let total = 0 -->
<!--       #   state.sortedData.forEach(function(row) { -->
<!--       #     total += row[column.id] -->
<!--       #   }) -->
<!--       #   return total.toFixed(0) -->
<!--       # }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0), -->
<!--       style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", borderRight = "1.5px solid rgb(230, 230, 230)") -->
<!--     ), -->

<!--     # Arrived = colDef( -->
<!--     #   name = "Referrals with Completed Appointments", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = "sum", -->
<!--     #   # footer = JS("function(column, state) { -->
<!--     #   #   let total = 0 -->
<!--     #   #   state.sortedData.forEach(function(row) { -->
<!--     #   #     total += row[column.id] -->
<!--     #   #   }) -->
<!--     #   #   return total.toFixed(0).toLocaleString() -->
<!--     #   # }"), -->
<!--     #   format = colFormat(separators = TRUE, digits = 0) -->
<!--     # ), -->
<!--     #  -->
<!--     # Pending = colDef( -->
<!--     #   name = "Referrals Unassigned (No Visits Linked)", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = "sum", -->
<!--     #   # footer = JS("function(column, state) { -->
<!--     #   #   let total = 0 -->
<!--     #   #   state.sortedData.forEach(function(row) { -->
<!--     #   #     total += row[column.id] -->
<!--     #   #   }) -->
<!--     #   #   return total.toFixed(0) -->
<!--     #   # }"), -->
<!--     #   format = colFormat(separators = TRUE, digits = 0), -->
<!--     #   style = list(borderRight = "1.5px solid rgb(230, 230, 230)") -->
<!--     # ), -->

<!--     conversion_rate = colDef( -->
<!--       name = "Conversion Rate", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalPending = 0 -->
<!--         let totalTotal = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalTotal += row['Total'] -->
<!--           totalPending += row['Pending'] -->
<!--         }) -->
<!--         return (totalTotal - totalPending) / totalTotal -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['conversion_rate'] -->
<!--         if (value > 0.5) { -->
<!--           var color = '#008000' -->
<!--         } else if (value <= 0.5 ) { -->
<!--           var color = '#e00000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 0) -->
<!--     ), -->

<!--     completion_rate = colDef( -->
<!--       name = "Completion Rate", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalArrived = 0 -->
<!--         let totalTotal = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalTotal += row['Total'] -->
<!--           totalArrived += row['Arrived'] -->
<!--         }) -->
<!--         return totalArrived / totalTotal -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['completion_rate'] -->
<!--         if (value > 0.5) { -->
<!--           var color = '#008000' -->
<!--         } else if (value <= 0.5 ) { -->
<!--           var color = '#e00000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 0) -->
<!--     ), -->

<!--     expired_unassigned_perc = colDef( -->
<!--       name = "Expired Referrals Unassigned Rate", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalExpiredUnassigned = 0 -->
<!--         let totalTotal = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalTotal += row['Total'] -->
<!--           totalExpiredUnassigned += row['expired_unassigned'] -->
<!--         }) -->
<!--         return totalExpiredUnassigned / totalTotal -->
<!--       }"), -->
<!--       # style = JS("function(rowInfo) { -->
<!--       #   var value = rowInfo.row['completion_rate'] -->
<!--       #   if (value > 0.5) { -->
<!--       #     var color = '#008000' -->
<!--       #   } else if (value <= 0.5 ) { -->
<!--       #     var color = '#e00000' -->
<!--       #   } else { -->
<!--       #     var color = '#000000' -->
<!--       #   } -->
<!--       #   return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       # }"), -->
<!--       style = list(color = "#e00000", fontWeight = "bold"), -->
<!--       format = colFormat(percent = TRUE, digits = 0) -->
<!--     ), -->

<!--     future_appts = colDef( -->
<!--       name = "Active Unassigned Referrals with Potential Upcoming Appointments", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = "sum", -->
<!--       # footer = JS("function(column, state) { -->
<!--       #   let total = 0 -->
<!--       #   state.sortedData.forEach(function(row) { -->
<!--       #     total += row[column.id] -->
<!--       #   }) -->
<!--       #   return total.toFixed(0) -->
<!--       # }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0), -->
<!--       style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff") -->
<!--     ), -->

<!--     past_appts = colDef( -->
<!--       name = "Active Unassigned Referrals with Potential COMPLETED Appointments", -->
<!--       minWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = "sum", -->
<!--       # footer = JS("function(column, state) { -->
<!--       #   let total = 0 -->
<!--       #   state.sortedData.forEach(function(row) { -->
<!--       #     total += row[column.id] -->
<!--       #   }) -->
<!--       #   return total.toFixed(0) -->
<!--       # }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0), -->
<!--       style = list(borderLeft = "1.5px solid rgb(230, 230, 230)", fontWeight = "bold", background = "#c9f0ff") -->
<!--     ), -->

<!--     Arrived = colDef( -->
<!--       show = F -->
<!--     ), -->

<!--     Pending = colDef( -->
<!--       show = F -->
<!--     ), -->

<!--     expired_unassigned = colDef( -->
<!--       show = F -->
<!--     ) -->

<!--   ) # Close Columns -->

<!--   ) # Close Reactable -->

<!-- ``` -->
<!-- <br/> -->
<!-- <br/> -->


<!-- ```{r Referrals Trend Processing, echo = FALSE, warning = FALSE, message = FALSE} -->

<!-- mshs_sites <- c("MSBI", "MSDMG", "MSH- Ambulatory Care", "MSH-MSDFP", -->
<!--                          "MSM", "MSUS", "MSW", "Network", "MSQ", "MSSN") -->


<!-- # Referrals Data by Month -->
<!--   referrals_trend_site <- referral_vol %>% -->
<!--     filter(ReceivedByDept != "*Unspecified") %>% -->
<!--     filter(Class != "Outgoing") %>% -->
<!--     filter(Status != "Denied") %>% -->
<!--     filter(ProcedureName %!in% referrals_excl) %>% -->
<!--     # filter(ReceivedBySite %in% mshs_sites) %>% -->
<!--     filter(StartInstant < report_run_date & StartInstant >= as.Date("2022-09-01", "%Y-%m-%d")) %>% -->
<!--     group_by(ReceivedBySite, createdMonthYear, ApptStatusFinal) %>% -->
<!--     summarise(total_vol = n()) %>% -->
<!--     pivot_wider(names_from = ApptStatusFinal, -->
<!--                 values_from = total_vol, -->
<!--                 values_fill = 0) -->

<!--   referrals_trend_site <- referrals_trend_site %>% -->
<!--     mutate(Total = sum(across(where(is.numeric)))) -->

<!--   referrals_trend_site <- referrals_trend_site %>% -->
<!--     group_by(createdMonthYear) %>% -->
<!--     bind_rows(summarise(., -->
<!--                       across(where(is.integer), sum), -->
<!--                       across(where(is.character), ~"*MSHS"))) %>% -->
<!--     mutate(conversion_rate = round((Total - Pending)/Total,2)*100, -->
<!--            completion_rate = round(Arrived/Total,2)*100) %>% -->
<!--     dplyr::select(ReceivedBySite, createdMonthYear, Total, Arrived,  Pending, conversion_rate, completion_rate) -->

<!--   referrals_trend_site <- referrals_trend_site %>% -->
<!--     mutate(createdMonthYear = format(as.yearmon(createdMonthYear, "%m-%Y"),"%Y-%m")) %>% -->
<!--     arrange(createdMonthYear) %>% -->
<!--     arrange(ReceivedBySite) -->

<!-- ``` -->


<!-- ## Referrals Trend - Site{.tabset .tabset-fade .tabset-pills} -->
<!-- ### Referrals Received -->
<!-- ```{r Referrals received Trend, echo = FALSE, warning = FALSE, message = FALSE} -->

<!--   map(unique(referrals_trend_site$ReceivedBySite), function(x){ -->
<!-- highchart() %>% -->
<!--   hc_yAxis_multiples( -->
<!--     list(title = list(text = "# of Referrals"), lineWidth = 3, min = 0), -->
<!--     list(title = list(text = "% of Referrals Received"), min = -50,max=200, -->
<!--            labels = list(format = '{value}%'), -->
<!--            showLastLabel = FALSE, opposite = TRUE) -->
<!--   ) %>% -->
<!--   hc_xAxis(title = list(text = ""), -->
<!--            categories = (referrals_trend_site %>% filter(ReceivedBySite == x))$createdMonthYear, -->
<!--            type = "datetime", -->
<!--            labels = list(format = '{value:%Y/%m}') -->
<!--            # dateTimeLabelFormats = list(month = '%Y-%m') -->
<!--            ) %>% -->
<!--   hc_add_series(name   = "Referrals Received", -->
<!--                 data   = (referrals_trend_site %>% filter(ReceivedBySite == x))$Total, -->
<!--                 type = "column", -->
<!--                                 zones = list(list(value = 0, -->
<!--                                   color = 'red')), -->
<!--                 color='#a5a7a5', -->
<!--                 marker = list(enabled= TRUE), -->
<!--                 dataLabels = list(enabled = TRUE, format='{point.y}') -->
<!--                 ) %>% -->
<!--   hc_add_series(name   = "Conversion Rate", -->
<!--                 data   = (referrals_trend_site %>% filter(ReceivedBySite == x))$conversion_rate, -->
<!--                  marker = list(enabled= TRUE), yAxis = 1, -->
<!--                 color='#00aeef', -->
<!--                 lineWidth=3, -->
<!--                 lineColor='#00aeef', -->
<!--                 dataLabels = list(enabled = TRUE, format='{point.y}%') -->
<!--                 ) %>% -->
<!--    hc_add_series(name   = "Completion Rate", -->
<!--                 data   = (referrals_trend_site %>% filter(ReceivedBySite == x))$completion_rate, -->
<!--                  marker = list(enabled= TRUE), yAxis = 1, -->
<!--                 color='#d80b8c', -->
<!--                 lineWidth=3, -->
<!--                 lineColor='#d80b8c', -->
<!--                 dataLabels = list(enabled = TRUE, format='{point.y}%') -->
<!--                 ) %>% -->
<!--   hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>% -->
<!--     hc_title(text = paste0(x, " - Referrals Outcome"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>% -->
<!--     # hc_subtitle(text = paste0("Includes Radiology and Rad Onc visits up to ",radiology_date,"<br> Based on visits from ",date_start," to ",date_end), -->
<!--     #           align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>% -->
<!--     hc_tooltip(shared = TRUE, borderColor = "black") -->
<!--   }) %>% -->
<!--   hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable() -->

<!-- ``` -->
<!-- <br/> -->
<!-- <br/> -->


<!-- ### Referrals Sent -->
<!-- ```{r Referrals Sent Trend, echo = FALSE, warning = FALSE, message = FALSE} -->

<!-- mshs_sites <- c("MSBI", "MSDMG", "MSH- Ambulatory Care", "MSH-MSDFP", -->
<!--                          "MSM", "MSUS", "MSW", "Network", "MSQ", "MSSN") -->


<!-- # Referrals Data by Month -->
<!--   referrals_trend_site_sent <- referral_vol %>% -->
<!--     filter(ReceivedByDept != "*Unspecified") %>% -->
<!--     filter(Class != "Outgoing") %>% -->
<!--     filter(Status != "Denied") %>% -->
<!--     filter(ProcedureName %!in% referrals_excl) %>% -->
<!--     filter(StartInstant < report_run_date & StartInstant >= as.Date("2022-09-01", "%Y-%m-%d")) %>% -->
<!--     group_by(SentBySite, createdMonthYear, ApptStatusFinal) %>% -->
<!--     summarise(total_vol = n()) %>% -->
<!--     pivot_wider(names_from = ApptStatusFinal, -->
<!--                 values_from = total_vol, -->
<!--                 values_fill = 0) -->

<!--   referrals_trend_site_sent <- referrals_trend_site_sent %>% -->
<!--     mutate(Total = sum(across(where(is.numeric)))) -->

<!--   referrals_trend_site_sent <- referrals_trend_site_sent %>% -->
<!--     group_by(createdMonthYear) %>% -->
<!--     bind_rows(summarise(., -->
<!--                       across(where(is.integer), sum), -->
<!--                       across(where(is.character), ~"*MSHS"))) %>% -->
<!--     mutate(conversion_rate = round((Total - Pending)/Total,2)*100, -->
<!--            completion_rate = round(Arrived/Total,2)*100) %>% -->
<!--     dplyr::select(SentBySite, createdMonthYear, Total, Arrived,  Pending, conversion_rate, completion_rate) -->

<!--   referrals_trend_site_sent <- referrals_trend_site_sent %>% -->
<!--     mutate(createdMonthYear = format(as.yearmon(createdMonthYear, "%m-%Y"),"%Y-%m")) %>% -->
<!--     arrange(createdMonthYear) %>% -->
<!--     arrange(SentBySite) -->


<!--   map(unique(referrals_trend_site_sent$SentBySite), function(x){ -->
<!-- highchart() %>% -->
<!--   hc_yAxis_multiples( -->
<!--     list(title = list(text = "# of Referrals"), lineWidth = 3, min = 0), -->
<!--     list(title = list(text = "% of Referrals Received"), min = -50,max=200, -->
<!--            labels = list(format = '{value}%'), -->
<!--            showLastLabel = FALSE, opposite = TRUE) -->
<!--   ) %>% -->
<!--   hc_xAxis(title = list(text = ""), -->
<!--            categories = (referrals_trend_site_sent %>% filter(SentBySite == x))$createdMonthYear, -->
<!--            type = "datetime", -->
<!--            labels = list(format = '{value:%Y/%m}') -->
<!--            # dateTimeLabelFormats = list(month = '%Y-%m') -->
<!--            ) %>% -->
<!--   hc_add_series(name   = "Referrals Sent", -->
<!--                 data   = (referrals_trend_site_sent %>% filter(SentBySite == x))$Total, -->
<!--                 type = "column", -->
<!--                                 zones = list(list(value = 0, -->
<!--                                   color = 'red')), -->
<!--                 color='#a5a7a5', -->
<!--                 marker = list(enabled= TRUE), -->
<!--                 dataLabels = list(enabled = TRUE, format='{point.y}') -->
<!--                 ) %>% -->
<!--   hc_add_series(name   = "Conversion Rate", -->
<!--                 data   = (referrals_trend_site_sent %>% filter(SentBySite == x))$conversion_rate, -->
<!--                  marker = list(enabled= TRUE), yAxis = 1, -->
<!--                 color='#00aeef', -->
<!--                 lineWidth=3, -->
<!--                 lineColor='#00aeef', -->
<!--                 dataLabels = list(enabled = TRUE, format='{point.y}%') -->
<!--                 ) %>% -->
<!--    hc_add_series(name   = "Completion Rate", -->
<!--                 data   = (referrals_trend_site_sent %>% filter(SentBySite == x))$completion_rate, -->
<!--                  marker = list(enabled= TRUE), yAxis = 1, -->
<!--                 color='#d80b8c', -->
<!--                 lineWidth=3, -->
<!--                 lineColor='#d80b8c', -->
<!--                 dataLabels = list(enabled = TRUE, format='{point.y}%') -->
<!--                 ) %>% -->
<!--   hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>% -->
<!--     hc_title(text = paste0(x, " - Referrals Outcome"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>% -->
<!--     # hc_subtitle(text = paste0("Includes Radiology and Rad Onc visits up to ",radiology_date,"<br> Based on visits from ",date_start," to ",date_end), -->
<!--     #           align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>% -->
<!--     hc_tooltip(shared = TRUE, borderColor = "black") -->
<!--   }) %>% -->
<!--   hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable() -->

<!-- ``` -->
<!-- <br/> -->
<!-- <br/> -->


## Unassigned Referrals {.tabset .tabset-fade .tabset-pills}
### Referrals Received
```{r Received Unassigned Output, echo = FALSE, warning = FALSE, message = FALSE}

htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Data (Unassigned RFL with Associated Appointments)"),
      onclick = "Reactable.downloadDataCSV('unassigned-download-table', 'Unassigned RFL Data')"
    ),

    reactable(
      rfl_same_spec %>%
        filter(ReceivedByDept != "*Unspecified") %>%
        dplyr::select(
                      SentBySite, SentBySpecialty, SentByDept, 
                      ReceivedBySite, ReceivedBySpecialtyFromDepDim, ReceivedByDept, ReceivedByDepID, ReceivedByProvider,
                      Creation_Date, ReferralEpicId, Patient_MRN, ProcedureName, Class, Status, 
                      same_spec, same_specialty, same_dept, lead_days,
                      PAT_ENC_CSN_ID, APPT_STATUS_NAME, APPT_MADE_DTTM, APPT_DTTM,
                      SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_NAME_WID, 
                      PAT_NAME, CONTACT_DATE,  PRC_NAME, APPT_ENTRY_USER_NAME_WID) %>%
        arrange(ReceivedBySite, ReceivedBySpecialtyFromDepDim),
      style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    searchable = TRUE,
    
    groupBy = c("ReceivedBySite", "ReceivedBySpecialtyFromDepDim", "ReceivedByDept"),
    elementId = "unassigned-download-table",
    
    columns = list(
    
    ReceivedBySite = colDef(
      # footer = "Total",
      name = "Refer to Site",
      minWidth = 180),
    
    ReceivedBySpecialtyFromDepDim = colDef(
      # footer = "Total",
      name = "Refer to Specialty",
      minWidth = 180),
    
    ReceivedByDept = colDef(
      # footer = "Total",
      name = "Refer to Dept",
      minWidth = 180),
    
    ReceivedByDepID = colDef(
      # footer = "Total",
      name = "Refer to Dept ID",
      minWidth = 180),
    
    ReceivedByProvider = colDef(
      # footer = "Total",
      name = "Refer to Provider",
      minWidth = 180),
    
    ReferralEpicId = colDef(
      # footer = "Total",
      name = "Referral ID"),
    
    Patient_MRN = colDef(
      # footer = "Total",
      name = "Patient MRN"),
    
    Creation_Date = colDef(
      # footer = "Total",
      name = "Referral Created Date"),
    
    ProcedureName = colDef(
      # footer = "Total",
      name = "Procedure Name"),
    
    Class = colDef(
      # footer = "Total",
      name = "Referral Class"),
    
    Status = colDef(
      # footer = "Total",
      name = "Referral Status"),
    
    same_specialty = colDef(
      # footer = "Total",
      name = "Referral in Same Specialty"),
    
    same_dept = colDef(
      # footer = "Total",
      name = "Referral in Same Department"),
    
    PAT_ENC_CSN_ID = colDef(
      # footer = "Total",
      name = "Encounter CSN ID"),
    
    SITE = colDef(
      # footer = "Total",
      name = "Scheduled Site"),
    
    DEPT_SPECIALTY_NAME = colDef(
      # footer = "Total",
      name = "Scheduled Dept Specialty"),
    
    DEPARTMENT_NAME = colDef(
      # footer = "Total",
      name = "Scheduled Dept"),
    
    DEPARTMENT_ID = colDef(
      # footer = "Total",
      name = "Scheduled Dept ID"),
    
    PROV_NAME_WID = colDef(
      # footer = "Total",
      name = "Scheduled Provider"),
    
    APPT_MADE_DTTM = colDef(
      # footer = "Total",
      name = "Appt Made Date/Time"),
    
    APPT_DTTM = colDef(
      # footer = "Total",
      name = "Appt Date/Time"),
    
    APPT_STATUS_NAME = colDef(
      # footer = "Total",
      name = "Appt Status"),
    
    SentBySite = colDef(show = F),
    SentBySpecialty = colDef(show = F),
    SentByDept = colDef(show = F),
    same_spec = colDef(show = F),
    PAT_NAME = colDef(show = F),
    APPT_ENTRY_USER_NAME_WID = colDef(show = F),
    CONTACT_DATE = colDef(show = F),
    PRC_NAME = colDef(show = F),
    lead_days = colDef(show = F)
    
    
    )

    )
  )
)



```
<br/>
<br/>


### Referrals Sent
```{r Sent Unassigned Output, echo = FALSE, warning = FALSE, message = FALSE}


htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Data (Unassigned RFL with Associated Appointments)"),
      onclick = "Reactable.downloadDataCSV('unassigned-download-table', 'Unassigned RFL Data')"
    ),

    reactable(
      rfl_same_spec %>%
        filter(ReceivedByDept != "*Unspecified") %>%
        dplyr::select(
                      SentBySite, SentBySpecialty, SentByDept, 
                      ReceivedBySite, ReceivedBySpecialtyFromDepDim, ReceivedByDept, ReceivedByDepID, ReceivedByProvider,
                      Creation_Date, ReferralEpicId, Patient_MRN, ProcedureName, Class, Status, 
                      same_spec, same_specialty, same_dept, lead_days,
                      PAT_ENC_CSN_ID, APPT_STATUS_NAME, APPT_MADE_DTTM, APPT_DTTM,
                      SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_NAME_WID, 
                      PAT_NAME, CONTACT_DATE,  PRC_NAME, APPT_ENTRY_USER_NAME_WID) %>%
        arrange(SentBySite, SentBySpecialty, ReferralEpicId, APPT_DTTM),
      style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    searchable = TRUE,
    
    groupBy = c("SentBySite", "SentBySpecialty", "SentByDept"),
    elementId = "unassigned-download-table",
    
    columns = list(
    
    SentBySite = colDef(
      # footer = "Total",
      name = "Refer from Site",
      minWidth = 180),
    
    SentBySpecialty = colDef(
      # footer = "Total",
      name = "Refer from Specialty",
      minWidth = 180),
    
    SentByDept = colDef(
      # footer = "Total",
      name = "Refer from Dept",
      minWidth = 180),
    
    SentByDepID = colDef(
      # footer = "Total",
      name = "Refer from Dept ID",
      minWidth = 180),
    
    SentByProvider = colDef(
      # footer = "Total",
      name = "Refer from Provider",
      minWidth = 180),
    
    ReceivedBySite = colDef(
      # footer = "Total",
      name = "Refer to Site",
      minWidth = 180),
    
    ReceivedBySpecialtyFromDepDim = colDef(
      # footer = "Total",
      name = "Refer to Specialty",
      minWidth = 180),
    
    ReceivedByDept = colDef(
      # footer = "Total",
      name = "Refer to Dept",
      minWidth = 180),
    
    ReceivedByDepID = colDef(
      # footer = "Total",
      name = "Refer to Dept ID",
      minWidth = 180),
    
    ReceivedByProvider = colDef(
      # footer = "Total",
      name = "Refer to Provider",
      minWidth = 180),
    
    ReferralEpicId = colDef(
      # footer = "Total",
      name = "Referral ID"),
    
    Patient_MRN = colDef(
      # footer = "Total",
      name = "Patient MRN"),
    
    Creation_Date = colDef(
      # footer = "Total",
      name = "Referral Created Date"),
    
    ProcedureName = colDef(
      # footer = "Total",
      name = "Procedure Name"),
    
    Class = colDef(
      # footer = "Total",
      name = "Referral Class"),
    
    Status = colDef(
      # footer = "Total",
      name = "Referral Status"),
    
    same_specialty = colDef(
      # footer = "Total",
      name = "Referral in Same Specialty"),
    
    same_dept = colDef(
      # footer = "Total",
      name = "Referral in Same Department"),
    
    PAT_ENC_CSN_ID = colDef(
      # footer = "Total",
      name = "Encounter CSN ID"),
    
    SITE = colDef(
      # footer = "Total",
      name = "Scheduled Site"),
    
    DEPT_SPECIALTY_NAME = colDef(
      # footer = "Total",
      name = "Scheduled Dept Specialty"),
    
    DEPARTMENT_NAME = colDef(
      # footer = "Total",
      name = "Scheduled Dept"),
    
    DEPARTMENT_ID = colDef(
      # footer = "Total",
      name = "Scheduled Dept ID"),
    
    PROV_NAME_WID = colDef(
      # footer = "Total",
      name = "Scheduled Provider"),
    
    APPT_MADE_DTTM = colDef(
      # footer = "Total",
      name = "Appt Made Date/Time"),
    
    APPT_DTTM = colDef(
      # footer = "Total",
      name = "Appt Date/Time"),
    
    APPT_STATUS_NAME = colDef(
      # footer = "Total",
      name = "Appt Status"),
    
    # SentBySite = colDef(show = F),
    # SentBySpecialty = colDef(show = F),
    # SentByDept = colDef(show = F),
    same_spec = colDef(show = F),
    PAT_NAME = colDef(show = F),
    APPT_ENTRY_USER_NAME_WID = colDef(show = F),
    CONTACT_DATE = colDef(show = F),
    PRC_NAME = colDef(show = F),
    lead_days = colDef(show = F)
    
    
    )

    )
  )
)


```
<br/>
<br/>


## Referrals W/O Referred-To DEP
```{r Referrals without referred-to department, echo = FALSE, warning = FALSE, message = FALSE}

htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Data (Unassigned RFL w/o Refer-to Department)"),
      onclick = "Reactable.downloadDataCSV('no-rfl-to-download-table', 'Unassigned RFL Data Missing Refer-to Dept')"
    ),

    reactable(
      rfl_same_spec %>%
        filter(ReceivedByDept == "*Unspecified") %>%
        dplyr::select(
                      SentBySite, SentBySpecialty, SentByDept, 
                      ReceivedBySite, ReceivedBySpecialtyFromDepDim, ReceivedByDept, ReceivedByDepID, ReceivedByProvider,
                      Creation_Date, ReferralEpicId, Patient_MRN, ProcedureName, Class, Status, 
                      same_spec, same_specialty, same_dept, lead_days,
                      PAT_ENC_CSN_ID, APPT_STATUS_NAME, APPT_MADE_DTTM, APPT_DTTM,
                      SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_NAME_WID, 
                      PAT_NAME, CONTACT_DATE,  PRC_NAME, APPT_ENTRY_USER_NAME_WID) %>%
        arrange(ReceivedBySite, ReceivedBySpecialtyFromDepDim),
      style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left", 
                           headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    searchable = TRUE,
    
    groupBy = c("ReceivedBySite", "ReceivedBySpecialtyFromDepDim", "ReceivedByDept"),
    elementId = "no-rfl-to-download-table",
    
    columns = list(
    
    ReceivedBySite = colDef(
      # footer = "Total",
      name = "Refer to Site",
      minWidth = 180),
    
    ReceivedBySpecialtyFromDepDim = colDef(
      # footer = "Total",
      name = "Refer to Specialty",
      minWidth = 180),
    
    ReceivedByDept = colDef(
      # footer = "Total",
      name = "Refer to Dept",
      minWidth = 180),
    
    ReceivedByDepID = colDef(
      # footer = "Total",
      name = "Refer to Dept ID",
      minWidth = 180),
    
    ReceivedByProvider = colDef(
      # footer = "Total",
      name = "Refer to Provider",
      minWidth = 180),
    
    ReferralEpicId = colDef(
      # footer = "Total",
      name = "Referral ID"),
    
    Patient_MRN = colDef(
      # footer = "Total",
      name = "Patient MRN"),
    
    Creation_Date = colDef(
      # footer = "Total",
      name = "Referral Created Date"),
    
    ProcedureName = colDef(
      # footer = "Total",
      name = "Procedure Name"),
    
    Class = colDef(
      # footer = "Total",
      name = "Referral Class"),
    
    Status = colDef(
      # footer = "Total",
      name = "Referral Status"),
    
    same_specialty = colDef(
      # footer = "Total",
      name = "Referral in Same Specialty"),
    
    same_dept = colDef(
      # footer = "Total",
      name = "Referral in Same Department"),
    
    PAT_ENC_CSN_ID = colDef(
      # footer = "Total",
      name = "Encounter CSN ID"),
    
    SITE = colDef(
      # footer = "Total",
      name = "Scheduled Site"),
    
    DEPT_SPECIALTY_NAME = colDef(
      # footer = "Total",
      name = "Scheduled Dept Specialty"),
    
    DEPARTMENT_NAME = colDef(
      # footer = "Total",
      name = "Scheduled Dept"),
    
    DEPARTMENT_ID = colDef(
      # footer = "Total",
      name = "Scheduled Dept ID"),
    
    PROV_NAME_WID = colDef(
      # footer = "Total",
      name = "Scheduled Provider"),
    
    APPT_MADE_DTTM = colDef(
      # footer = "Total",
      name = "Appt Made Date/Time"),
    
    APPT_DTTM = colDef(
      # footer = "Total",
      name = "Appt Date/Time"),
    
    APPT_STATUS_NAME = colDef(
      # footer = "Total",
      name = "Appt Status"),
    
    SentBySite = colDef(show = F),
    SentBySpecialty = colDef(show = F),
    SentByDept = colDef(show = F),
    same_spec = colDef(show = F),
    PAT_NAME = colDef(show = F),
    APPT_ENTRY_USER_NAME_WID = colDef(show = F),
    CONTACT_DATE = colDef(show = F),
    PRC_NAME = colDef(show = F),
    lead_days = colDef(show = F)
    
    
    )

    )
  )
)


```



